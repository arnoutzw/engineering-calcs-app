<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VDI Heat Transfer Calculator</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#09090b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace']
      }
    }
  }
}
</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#09090b;--surface:#18181b;--card:#27272a;--border:#3f3f46;
  --text:#f4f4f5;--muted:#a1a1aa;--accent:#f59e0b;--accent2:#fbbf24;
  --success:#4ade80;--info:#f59e0b;--danger:#f87171;
  --radius:10px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
html{font-size:15px;scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;font-size:0.875rem;
  background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
a{color:var(--accent)}

/* Header */
header{background:rgba(24,24,27,.8);
  padding:1rem 1.5rem;border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:100;backdrop-filter:blur(12px)}
header h1{font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
header h1 .icon{color:var(--accent);font-size:1.4rem}
header .subtitle{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--muted);margin-top:2px}

/* Tabs */
.tabs{display:flex;background:var(--surface);border-bottom:2px solid var(--border);
  overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{font-family:'JetBrains Mono',monospace;flex:1;min-width:fit-content;padding:.75rem 1.25rem;text-align:center;cursor:pointer;
  font-size:.82rem;font-weight:500;color:var(--muted);border:none;background:none;
  border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap}
.tab:hover{color:var(--text);background:rgba(245,158,11,.05)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(245,158,11,.08)}
.tab svg{width:18px;height:18px;vertical-align:middle;margin-right:4px}

/* Panels */
.panel{display:none;padding:1rem;max-width:900px;margin:0 auto}
.panel.active{display:block}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;
  padding:1.25rem;margin-bottom:1rem;box-shadow:var(--shadow);transition:all .3s}
.card:hover{border-color:rgba(245,158,11,.5);box-shadow:0 8px 30px rgba(245,158,11,.1)}
.card h2{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;margin-bottom:.75rem;color:var(--accent2);display:flex;align-items:center;gap:.4rem}
.card h3{font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:700;color:var(--text);margin:1rem 0 .5rem}

/* Forms */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem}
.form-row.three{grid-template-columns:1fr 1fr 1fr}
.form-group{display:flex;flex-direction:column}
.form-group.full{grid-column:1/-1}
label{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--muted);margin-bottom:3px;font-weight:500}
label .unit{color:var(--accent);font-weight:400}
input,select{font-family:'JetBrains Mono',monospace;background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:.625rem 1rem;color:var(--text);font-size:.875rem;transition:border-color .2s;width:100%}
input:focus,select:focus{outline:none;border-color:var(--accent)}
input::placeholder{color:#52525b}
select{cursor:pointer}

/* Buttons */
.btn{font-family:'JetBrains Mono',monospace;display:inline-flex;align-items:center;justify-content:center;gap:.4rem;
  padding:.625rem 1rem;border:none;border-radius:8px;font-size:.875rem;font-weight:700;
  cursor:pointer;transition:all .2s}
.btn-primary{background:var(--accent);color:#18181b}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm{font-size:.75rem;padding:.375rem .75rem}
.btn-row{display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap}

/* Results */
.results{background:linear-gradient(135deg,rgba(245,158,11,.06),rgba(245,158,11,.02));
  border:1px solid rgba(245,158,11,.25);border-radius:var(--radius);padding:1.25rem;
  margin-top:1rem;display:none}
.results.show{display:block}
.results h3{color:var(--accent);font-size:.92rem;margin-bottom:.75rem}
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.result-item{display:flex;justify-content:space-between;align-items:baseline;
  padding:.4rem .6rem;border-radius:4px;background:rgba(0,0,0,.2)}
.result-item .lbl{font-size:.78rem;color:var(--muted)}
.result-item .val{font-family:'JetBrains Mono',monospace;font-size:.92rem;font-weight:600;color:var(--text);font-variant-numeric:tabular-nums}
.result-item .val .unit{font-size:.72rem;color:var(--muted);font-weight:400;margin-left:3px}
.result-item.highlight{background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3)}
.result-item.highlight .val{color:var(--accent)}
.result-item.full{grid-column:1/-1}
.result-note{font-size:.75rem;color:var(--muted);margin-top:.75rem;padding:.5rem;
  background:rgba(245,158,11,.08);border-radius:4px;border-left:3px solid var(--accent)}

/* Fluid props display */
.props-display{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
  gap:.4rem;margin-top:.5rem;padding:.5rem;background:rgba(0,0,0,.15);border-radius:6px}
.prop-chip{font-family:'JetBrains Mono',monospace;font-size:.72rem;padding:.25rem .5rem;border-radius:4px;background:var(--card);
  display:flex;justify-content:space-between;gap:.5rem}
.prop-chip .pk{color:var(--muted)}.prop-chip .pv{color:var(--accent);font-weight:600}

/* Info tooltips */
.info-tag{font-family:'JetBrains Mono',monospace;display:inline-block;font-size:.68rem;padding:2px 8px;border-radius:4px;
  background:rgba(245,158,11,.1);color:var(--accent2);margin-left:.5rem;font-weight:400}

/* Responsive */
@media(max-width:600px){
  .form-row,.form-row.three{grid-template-columns:1fr}
  .result-grid{grid-template-columns:1fr}
  .tabs{gap:0}
  .tab{padding:.65rem .75rem;font-size:.76rem}
  .panel{padding:.75rem}
}

/* Animation */
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.results.show{animation:fadeIn .3s ease}

/* Description text */
.desc{font-size:.78rem;color:var(--muted);margin-bottom:1rem}

/* Scrollbars */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:#18181b}
::-webkit-scrollbar-thumb{background:#3f3f46;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#52525b}

/* Separator */
.sep{border:none;border-top:1px solid var(--border);margin:1rem 0}
</style>
</head>
<body>

<header>
  <h1><span class="icon">Q&#x0307;</span> VDI Heat Transfer Calculator</h1>
  <div class="subtitle">Based on VDI Heat Atlas correlations &middot; Works offline</div>
</header>

<nav class="tabs" role="tablist">
  <button class="tab active" onclick="switchTab('forced')" role="tab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20M7 7l10 10M17 7L7 17"/></svg>
    Forced Conv.
  </button>
  <button class="tab" onclick="switchTab('free')" role="tab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c-4 0-8-3.5-8-8 0-6 8-12 8-12s8 6 8 12c0 4.5-4 8-8 8z"/></svg>
    Free Conv.
  </button>
  <button class="tab" onclick="switchTab('cond')" role="tab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="12" x2="21" y2="12"/></svg>
    Conduction
  </button>
  <button class="tab" onclick="switchTab('rad')" role="tab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    Radiation
  </button>
  <button class="tab" onclick="switchTab('hx')" role="tab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 7h20M2 17h20"/><path d="M6 3v18M18 3v18"/><path d="M2 12h20" stroke-dasharray="3 2"/></svg>
    Heat Exchanger
  </button>
</nav>

<!-- ==================== FORCED CONVECTION ==================== -->
<div id="panel-forced" class="panel active">
  <div class="card">
    <h2>Forced Convection in Circular Tubes <span class="info-tag">VDI G1</span></h2>
    <p class="desc">
      Gnielinski correlation for turbulent flow, VDI approach for laminar and transition regimes.
    </p>

    <div class="form-row">
      <div class="form-group">
        <label>Fluid</label>
        <select id="fc-fluid" onchange="updateFluidProps('fc')">
          <option value="water">Water (liquid)</option>
          <option value="air">Air (1 bar)</option>
          <option value="custom">Custom (manual)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Bulk temperature <span class="unit">[&deg;C]</span></label>
        <input type="number" id="fc-Tb" value="60" step="1" onchange="updateFluidProps('fc')">
      </div>
    </div>

    <div id="fc-props-display" class="props-display"></div>

    <div id="fc-custom-props" style="display:none;margin-top:.75rem">
      <h3>Manual Fluid Properties</h3>
      <div class="form-row three">
        <div class="form-group"><label>&rho; <span class="unit">[kg/m&sup3;]</span></label>
          <input type="number" id="fc-rho" step="any"></div>
        <div class="form-group"><label>c<sub>p</sub> <span class="unit">[J/(kg&middot;K)]</span></label>
          <input type="number" id="fc-cp" step="any"></div>
        <div class="form-group"><label>&lambda; <span class="unit">[W/(m&middot;K)]</span></label>
          <input type="number" id="fc-lambda" step="any"></div>
      </div>
      <div class="form-row three">
        <div class="form-group"><label>&mu; <span class="unit">[Pa&middot;s]</span></label>
          <input type="number" id="fc-mu" step="any"></div>
        <div class="form-group"><label>Pr <span class="unit">[-]</span></label>
          <input type="number" id="fc-Pr" step="any"></div>
        <div class="form-group"><label>Pr<sub>w</sub> at wall T <span class="unit">[-]</span></label>
          <input type="number" id="fc-Prw" step="any"></div>
      </div>
    </div>

    <hr class="sep">

    <div class="form-row">
      <div class="form-group">
        <label>Boundary condition</label>
        <select id="fc-bc">
          <option value="constT">Constant wall temperature</option>
          <option value="constQ">Constant heat flux</option>
        </select>
      </div>
      <div class="form-group">
        <label>Wall temperature <span class="unit">[&deg;C]</span></label>
        <input type="number" id="fc-Tw" value="100" step="1">
      </div>
    </div>

    <div class="form-row three">
      <div class="form-group">
        <label>Inner diameter d <span class="unit">[mm]</span></label>
        <input type="number" id="fc-d" value="25" step="0.1">
      </div>
      <div class="form-group">
        <label>Pipe length L <span class="unit">[m]</span></label>
        <input type="number" id="fc-L" value="2" step="0.1">
      </div>
      <div class="form-group">
        <label>Mean velocity <span class="unit">[m/s]</span></label>
        <input type="number" id="fc-v" value="1.0" step="0.01">
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="calcForced()">Calculate</button>
      <button class="btn btn-outline" onclick="clearResults('fc')">Clear</button>
    </div>

    <div id="fc-results" class="results">
      <h3>Results</h3>
      <div id="fc-results-grid" class="result-grid"></div>
      <div id="fc-results-note" class="result-note"></div>
    </div>
  </div>
</div>

<!-- ==================== FREE CONVECTION ==================== -->
<div id="panel-free" class="panel">
  <div class="card">
    <h2>Free (Natural) Convection <span class="info-tag">VDI F2</span></h2>
    <p class="desc">
      Churchill &amp; Chu correlations for vertical plates, horizontal plates, and horizontal cylinders.
    </p>

    <div class="form-row">
      <div class="form-group">
        <label>Fluid</label>
        <select id="nc-fluid" onchange="updateFluidProps('nc')">
          <option value="water">Water (liquid)</option>
          <option value="air" selected>Air (1 bar)</option>
          <option value="custom">Custom (manual)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Film temperature T<sub>f</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="nc-Tf" value="50" step="1" onchange="updateFluidProps('nc')">
      </div>
    </div>

    <div id="nc-props-display" class="props-display"></div>

    <div id="nc-custom-props" style="display:none;margin-top:.75rem">
      <h3>Manual Fluid Properties (at film temperature)</h3>
      <div class="form-row three">
        <div class="form-group"><label>&rho; <span class="unit">[kg/m&sup3;]</span></label>
          <input type="number" id="nc-rho" step="any"></div>
        <div class="form-group"><label>c<sub>p</sub> <span class="unit">[J/(kg&middot;K)]</span></label>
          <input type="number" id="nc-cp" step="any"></div>
        <div class="form-group"><label>&lambda; <span class="unit">[W/(m&middot;K)]</span></label>
          <input type="number" id="nc-lambda" step="any"></div>
      </div>
      <div class="form-row three">
        <div class="form-group"><label>&mu; <span class="unit">[Pa&middot;s]</span></label>
          <input type="number" id="nc-mu" step="any"></div>
        <div class="form-group"><label>Pr <span class="unit">[-]</span></label>
          <input type="number" id="nc-Pr" step="any"></div>
        <div class="form-group"><label>&beta; <span class="unit">[1/K]</span></label>
          <input type="number" id="nc-beta" step="any"></div>
      </div>
    </div>

    <hr class="sep">

    <div class="form-row">
      <div class="form-group">
        <label>Geometry</label>
        <select id="nc-geom" onchange="toggleNCFields()">
          <option value="vert-plate">Vertical flat plate</option>
          <option value="horiz-plate-up">Horizontal plate (hot side up)</option>
          <option value="horiz-plate-down">Horizontal plate (hot side down)</option>
          <option value="horiz-cyl">Horizontal cylinder</option>
        </select>
      </div>
      <div class="form-group">
        <label id="nc-Lchar-label">Height L <span class="unit">[m]</span></label>
        <input type="number" id="nc-Lchar" value="0.5" step="0.01">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Surface temperature T<sub>s</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="nc-Ts" value="80" step="1">
      </div>
      <div class="form-group">
        <label>Ambient temperature T<sub>&infin;</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="nc-Tinf" value="20" step="1">
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="calcFree()">Calculate</button>
      <button class="btn btn-outline" onclick="clearResults('nc')">Clear</button>
    </div>

    <div id="nc-results" class="results">
      <h3>Results</h3>
      <div id="nc-results-grid" class="result-grid"></div>
      <div id="nc-results-note" class="result-note"></div>
    </div>
  </div>
</div>

<!-- ==================== CONDUCTION ==================== -->
<div id="panel-cond" class="panel">
  <div class="card">
    <h2>Steady-State Heat Conduction <span class="info-tag">VDI E</span></h2>
    <p class="desc">
      Through flat walls, cylindrical walls, and spherical shells. Supports multi-layer configurations.
    </p>

    <div class="form-row">
      <div class="form-group">
        <label>Geometry</label>
        <select id="cd-geom" onchange="toggleCDFields()">
          <option value="flat">Flat wall (plane)</option>
          <option value="cylinder">Cylindrical wall</option>
          <option value="sphere">Spherical shell</option>
        </select>
      </div>
      <div class="form-group" id="cd-area-group">
        <label>Wall area A <span class="unit">[m&sup2;]</span></label>
        <input type="number" id="cd-A" value="1" step="0.01">
      </div>
    </div>

    <div id="cd-cyl-dims" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label>Pipe length <span class="unit">[m]</span></label>
          <input type="number" id="cd-pipe-L" value="1" step="0.1">
        </div>
        <div class="form-group">
          <label>Inner radius r<sub>i</sub> <span class="unit">[mm]</span></label>
          <input type="number" id="cd-ri" value="12.5" step="0.1">
        </div>
      </div>
    </div>

    <div id="cd-sph-dims" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label>Inner radius r<sub>i</sub> <span class="unit">[mm]</span></label>
          <input type="number" id="cd-sri" value="50" step="0.1">
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Hot side T<sub>1</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="cd-T1" value="200" step="1">
      </div>
      <div class="form-group">
        <label>Cold side T<sub>2</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="cd-T2" value="30" step="1">
      </div>
    </div>

    <h3>Layers (inner &rarr; outer)</h3>
    <div id="cd-layers">
      <div class="form-row layer-row" data-layer="0">
        <div class="form-group">
          <label>Thickness <span class="unit">[mm]</span></label>
          <input type="number" class="cd-layer-t" value="5" step="0.1">
        </div>
        <div class="form-group">
          <label>Conductivity &lambda; <span class="unit">[W/(m&middot;K)]</span></label>
          <input type="number" class="cd-layer-k" value="50" step="0.01">
        </div>
      </div>
    </div>

    <div class="btn-row" style="margin-bottom:1rem">
      <button class="btn btn-outline btn-sm" onclick="addLayer()">+ Add Layer</button>
      <button class="btn btn-outline btn-sm" onclick="removeLayer()">&minus; Remove Layer</button>
    </div>

    <h3>Convective boundary conditions (optional)</h3>
    <div class="form-row">
      <div class="form-group">
        <label>h<sub>inner</sub> <span class="unit">[W/(m&sup2;&middot;K)]</span></label>
        <input type="number" id="cd-hi" placeholder="&infin; (leave empty to skip)" step="1">
      </div>
      <div class="form-group">
        <label>h<sub>outer</sub> <span class="unit">[W/(m&sup2;&middot;K)]</span></label>
        <input type="number" id="cd-ho" placeholder="&infin; (leave empty to skip)" step="1">
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="calcConduction()">Calculate</button>
      <button class="btn btn-outline" onclick="clearResults('cd')">Clear</button>
    </div>

    <div id="cd-results" class="results">
      <h3>Results</h3>
      <div id="cd-results-grid" class="result-grid"></div>
      <div id="cd-results-note" class="result-note"></div>
    </div>
  </div>
</div>

<!-- ==================== RADIATION ==================== -->
<div id="panel-rad" class="panel">
  <div class="card">
    <h2>Thermal Radiation <span class="info-tag">VDI K</span></h2>
    <p class="desc">
      Stefan-Boltzmann law, exchange between grey surfaces, and common view factors.
    </p>

    <div class="form-row">
      <div class="form-group">
        <label>Configuration</label>
        <select id="rd-config" onchange="toggleRDFields()">
          <option value="single">Single surface to surroundings</option>
          <option value="parallel">Two infinite parallel plates</option>
          <option value="enclosed">Small body enclosed by large surface</option>
          <option value="arbitrary">Two arbitrary surfaces (with view factor)</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>T<sub>1</sub> (hot surface) <span class="unit">[&deg;C]</span></label>
        <input type="number" id="rd-T1" value="400" step="1">
      </div>
      <div class="form-group">
        <label>T<sub>2</sub> (cold / surroundings) <span class="unit">[&deg;C]</span></label>
        <input type="number" id="rd-T2" value="25" step="1">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>&epsilon;<sub>1</sub> (emissivity surface 1) <span class="unit">[-]</span></label>
        <input type="number" id="rd-eps1" value="0.9" step="0.01" min="0" max="1">
      </div>
      <div class="form-group" id="rd-eps2-group">
        <label>&epsilon;<sub>2</sub> (emissivity surface 2) <span class="unit">[-]</span></label>
        <input type="number" id="rd-eps2" value="0.9" step="0.01" min="0" max="1">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Area A<sub>1</sub> <span class="unit">[m&sup2;]</span></label>
        <input type="number" id="rd-A1" value="1" step="0.01">
      </div>
      <div class="form-group" id="rd-F12-group">
        <label>View factor F<sub>12</sub> <span class="unit">[-]</span></label>
        <input type="number" id="rd-F12" value="1" step="0.01" min="0" max="1">
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="calcRadiation()">Calculate</button>
      <button class="btn btn-outline" onclick="clearResults('rd')">Clear</button>
    </div>

    <div id="rd-results" class="results">
      <h3>Results</h3>
      <div id="rd-results-grid" class="result-grid"></div>
      <div id="rd-results-note" class="result-note"></div>
    </div>
  </div>
</div>

<!-- ==================== HEAT EXCHANGER ==================== -->
<div id="panel-hx" class="panel">
  <div class="card">
    <h2>Heat Exchanger Design &amp; Rating <span class="info-tag">VDI C/D</span></h2>
    <p class="desc">
      LMTD and &epsilon;-NTU methods with F-correction factors for counterflow, parallel flow, crossflow, and shell-and-tube configurations.
    </p>

    <div class="form-row">
      <div class="form-group">
        <label>Calculation mode</label>
        <select id="hx-mode" onchange="toggleHXFields()">
          <option value="design">Design &mdash; find required area A</option>
          <option value="rating">Rating &mdash; find outlet temps &amp; Q</option>
          <option value="check">Performance check &mdash; all temps known</option>
        </select>
      </div>
      <div class="form-group">
        <label>Configuration</label>
        <select id="hx-config" onchange="toggleHXFields()">
          <option value="counter">Counterflow</option>
          <option value="parallel">Parallel flow (co-current)</option>
          <option value="cross-UU">Crossflow (both unmixed)</option>
          <option value="cross-MU">Crossflow (C<sub>max</sub> mixed, C<sub>min</sub> unmixed)</option>
          <option value="cross-UM">Crossflow (C<sub>min</sub> mixed, C<sub>max</sub> unmixed)</option>
          <option value="shell-1-2">Shell &amp; tube (1-2 TEMA E)</option>
          <option value="shell-1-4">Shell &amp; tube (1-4)</option>
        </select>
      </div>
    </div>

    <hr class="sep">
    <h3>Hot side</h3>
    <div class="form-row three">
      <div class="form-group">
        <label>T<sub>h,in</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="hx-Thi" value="150" step="1">
      </div>
      <div class="form-group" id="hx-Tho-group">
        <label>T<sub>h,out</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="hx-Tho" value="90" step="1">
      </div>
      <div class="form-group">
        <label>&#7747;<sub>h</sub>&middot;c<sub>p,h</sub> (= C<sub>h</sub>) <span class="unit">[W/K]</span></label>
        <input type="number" id="hx-Ch" value="5000" step="100">
      </div>
    </div>

    <h3>Cold side</h3>
    <div class="form-row three">
      <div class="form-group">
        <label>T<sub>c,in</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="hx-Tci" value="20" step="1">
      </div>
      <div class="form-group" id="hx-Tco-group">
        <label>T<sub>c,out</sub> <span class="unit">[&deg;C]</span></label>
        <input type="number" id="hx-Tco" value="80" step="1">
      </div>
      <div class="form-group">
        <label>&#7747;<sub>c</sub>&middot;c<sub>p,c</sub> (= C<sub>c</sub>) <span class="unit">[W/K]</span></label>
        <input type="number" id="hx-Cc" value="4000" step="100">
      </div>
    </div>

    <hr class="sep">
    <h3>Heat exchanger parameters</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Overall heat transfer coeff. U <span class="unit">[W/(m&sup2;&middot;K)]</span></label>
        <input type="number" id="hx-U" value="500" step="10">
      </div>
      <div class="form-group" id="hx-A-group">
        <label>Heat transfer area A <span class="unit">[m&sup2;]</span></label>
        <input type="number" id="hx-A" value="5" step="0.1">
      </div>
    </div>

    <div id="hx-fouling-section">
      <div class="form-row">
        <div class="form-group">
          <label>Fouling resistance R<sub>f</sub> (total) <span class="unit">[m&sup2;&middot;K/W]</span></label>
          <input type="number" id="hx-Rf" value="0" step="0.0001" placeholder="0 = no fouling">
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="calcHX()">Calculate</button>
      <button class="btn btn-outline" onclick="clearResults('hx')">Clear</button>
    </div>

    <div id="hx-results" class="results">
      <h3>Results</h3>
      <div id="hx-results-grid" class="result-grid"></div>
      <div id="hx-results-note" class="result-note"></div>
    </div>
  </div>
</div>

<script>
// =====================================================================
// FLUID PROPERTY DATABASE
// VDI Heat Atlas property tables for water and dry air
// =====================================================================

const FLUID_DB = {
  water: {
    name: 'Water (liquid, saturation)',
    T:      [0,    10,   20,   30,   40,   50,   60,   70,   80,   90,   100,  110,  120,  140,  160,  180,  200],
    rho:    [999.8,999.7,998.2,995.6,992.2,988.1,983.2,977.8,971.8,965.3,958.4,951.0,943.1,926.1,907.4,887.0,864.7],
    cp:     [4217, 4193, 4182, 4178, 4179, 4181, 4185, 4190, 4197, 4205, 4216, 4229, 4244, 4283, 4339, 4410, 4497],
    lambda: [0.561,0.580,0.598,0.615,0.631,0.643,0.654,0.663,0.670,0.675,0.679,0.682,0.683,0.683,0.680,0.673,0.663],
    mu:     [1.792e-3,1.307e-3,1.002e-3,0.798e-3,0.653e-3,0.547e-3,0.467e-3,0.404e-3,0.355e-3,0.315e-3,0.282e-3,0.255e-3,0.232e-3,0.196e-3,0.170e-3,0.150e-3,0.134e-3],
    Pr:     [13.44,9.45, 7.01, 5.42, 4.33, 3.56, 2.99, 2.55, 2.22, 1.96, 1.75, 1.58, 1.44, 1.23, 1.09, 0.98, 0.91],
    beta:   [-0.68e-4,0.88e-4,2.07e-4,3.03e-4,3.85e-4,4.49e-4,5.23e-4,5.84e-4,6.32e-4,6.95e-4,7.52e-4,8.05e-4,8.55e-4,9.66e-4,10.9e-4,12.3e-4,14.1e-4]
  },
  air: {
    name: 'Dry air (1 bar)',
    T:      [-50,  -20,  0,    20,   40,   60,   80,   100,  150,  200,  250,  300,  400,  500],
    rho:    [1.584,1.395,1.293,1.205,1.127,1.059,0.999,0.946,0.834,0.746,0.674,0.616,0.524,0.456],
    cp:     [1006, 1006, 1006, 1007, 1007, 1008, 1010, 1012, 1017, 1023, 1033, 1040, 1059, 1078],
    lambda: [0.0204,0.0228,0.0243,0.0257,0.0271,0.0285,0.0299,0.0314,0.0349,0.0383,0.0417,0.0448,0.0509,0.0566],
    mu:     [1.474e-5,1.622e-5,1.716e-5,1.813e-5,1.907e-5,1.999e-5,2.087e-5,2.172e-5,2.380e-5,2.577e-5,2.760e-5,2.947e-5,3.291e-5,3.613e-5],
    Pr:     [0.728,0.715,0.711,0.711,0.709,0.708,0.706,0.699,0.692,0.688,0.684,0.684,0.685,0.688],
    beta:   null // computed as 1/T(K) for ideal gas
  }
};

function lerp(x, xArr, yArr) {
  if (x <= xArr[0]) return yArr[0];
  if (x >= xArr[xArr.length - 1]) return yArr[yArr.length - 1];
  for (let i = 0; i < xArr.length - 1; i++) {
    if (x >= xArr[i] && x <= xArr[i + 1]) {
      const t = (x - xArr[i]) / (xArr[i + 1] - xArr[i]);
      return yArr[i] + t * (yArr[i + 1] - yArr[i]);
    }
  }
  return yArr[yArr.length - 1];
}

function getFluidProps(fluid, T) {
  const db = FLUID_DB[fluid];
  if (!db) return null;
  const props = {
    rho: lerp(T, db.T, db.rho),
    cp: lerp(T, db.T, db.cp),
    lambda: lerp(T, db.T, db.lambda),
    mu: lerp(T, db.T, db.mu),
    Pr: lerp(T, db.T, db.Pr),
    beta: db.beta ? lerp(T, db.T, db.beta) : 1 / (T + 273.15),
    nu: null
  };
  props.nu = props.mu / props.rho;
  return props;
}

// =====================================================================
// UI HELPERS
// =====================================================================

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  const tabs = ['forced', 'free', 'cond', 'rad', 'hx'];
  document.querySelectorAll('.tab')[tabs.indexOf(name)].classList.add('active');
}

function fmt(val, digits) {
  if (val === undefined || val === null || isNaN(val)) return '—';
  if (Math.abs(val) >= 1e5 || (Math.abs(val) < 0.01 && val !== 0))
    return val.toExponential(digits || 3);
  return val.toFixed(digits !== undefined ? digits : 2);
}

function fmtSci(val, digits) {
  if (val === undefined || val === null || isNaN(val)) return '—';
  return val.toExponential(digits || 3);
}

function resultHTML(items) {
  return items.map(it => {
    const cls = it.highlight ? 'result-item highlight' : 'result-item';
    const full = it.full ? ' full' : '';
    return `<div class="${cls}${full}"><span class="lbl">${it.label}</span><span class="val">${it.value}<span class="unit">${it.unit || ''}</span></span></div>`;
  }).join('');
}

function clearResults(prefix) {
  const el = document.getElementById(prefix + '-results');
  if (el) { el.classList.remove('show'); }
}

function updateFluidProps(prefix) {
  const fluid = document.getElementById(prefix + '-fluid').value;
  const customDiv = document.getElementById(prefix + '-custom-props');
  const propsDiv = document.getElementById(prefix + '-props-display');

  if (fluid === 'custom') {
    customDiv.style.display = 'block';
    propsDiv.innerHTML = '';
    return;
  }
  customDiv.style.display = 'none';

  let T;
  if (prefix === 'fc') T = parseFloat(document.getElementById('fc-Tb').value);
  else if (prefix === 'nc') T = parseFloat(document.getElementById('nc-Tf').value);
  if (isNaN(T)) return;

  const p = getFluidProps(fluid, T);
  if (!p) return;

  propsDiv.innerHTML = [
    { k: '&rho;', v: fmt(p.rho, 1), u: 'kg/m&sup3;' },
    { k: 'c<sub>p</sub>', v: fmt(p.cp, 0), u: 'J/(kg&middot;K)' },
    { k: '&lambda;', v: fmt(p.lambda, 4), u: 'W/(m&middot;K)' },
    { k: '&mu;', v: fmtSci(p.mu, 3), u: 'Pa&middot;s' },
    { k: 'Pr', v: fmt(p.Pr, 3), u: '' },
    { k: '&beta;', v: fmtSci(p.beta, 3), u: '1/K' },
    { k: '&nu;', v: fmtSci(p.nu, 3), u: 'm&sup2;/s' }
  ].map(i => `<div class="prop-chip"><span class="pk">${i.k}</span><span class="pv">${i.v} ${i.u}</span></div>`).join('');
}

// Initialize fluid displays
document.addEventListener('DOMContentLoaded', () => {
  updateFluidProps('fc');
  updateFluidProps('nc');
  toggleNCFields();
  toggleCDFields();
  toggleRDFields();
  toggleHXFields();
});

// =====================================================================
// FORCED CONVECTION (VDI G1)
// =====================================================================

function calcForced() {
  const fluid = document.getElementById('fc-fluid').value;
  const Tb = parseFloat(document.getElementById('fc-Tb').value);
  const Tw = parseFloat(document.getElementById('fc-Tw').value);
  const d_mm = parseFloat(document.getElementById('fc-d').value);
  const L = parseFloat(document.getElementById('fc-L').value);
  const v = parseFloat(document.getElementById('fc-v').value);
  const bc = document.getElementById('fc-bc').value;
  const d = d_mm / 1000;

  let props, Pr_w;
  if (fluid === 'custom') {
    props = {
      rho: parseFloat(document.getElementById('fc-rho').value),
      cp: parseFloat(document.getElementById('fc-cp').value),
      lambda: parseFloat(document.getElementById('fc-lambda').value),
      mu: parseFloat(document.getElementById('fc-mu').value),
      Pr: parseFloat(document.getElementById('fc-Pr').value)
    };
    props.nu = props.mu / props.rho;
    Pr_w = parseFloat(document.getElementById('fc-Prw').value) || props.Pr;
  } else {
    props = getFluidProps(fluid, Tb);
    const propsW = getFluidProps(fluid, Tw);
    Pr_w = propsW.Pr;
  }

  const Re = v * d / props.nu;
  const Pr = props.Pr;

  // Konakov friction factor
  const xi = (val) => Math.pow(1.8 * Math.log10(val) - 1.5, -2);

  // Correction factor K
  const isGas = (fluid === 'air');
  let K_turb, K_lam;
  if (isGas) {
    const Tb_K = Tb + 273.15, Tw_K = Tw + 273.15;
    K_turb = Math.pow(Tb_K / Tw_K, 0.45);
    K_lam = 1; // small effect for gas
  } else {
    K_turb = Math.pow(Pr / Pr_w, 0.11);
    const mu_b = props.mu;
    const mu_w = fluid !== 'custom' ? getFluidProps(fluid, Tw).mu : props.mu;
    K_lam = Math.pow(mu_b / mu_w, 0.14);
  }

  let Nu, regime;

  // VDI Laminar: Re < 2300
  function nuLam(Re_val) {
    const Nu1 = (bc === 'constT') ? 3.66 : 4.364;
    const Nu2 = 1.615 * Math.pow(Re_val * Pr * d / L, 1 / 3);
    const Nu3 = Math.pow(2 / (1 + 22 * Pr), 1 / 6) * Math.pow(Re_val * Pr * d / L, 0.5);
    return Math.pow(Math.pow(Nu1, 3) + 0.7 * 0.7 * 0.7 + Math.pow(Math.max(Nu2 - 0.7, 0), 3) + Math.pow(Nu3, 3), 1 / 3) * K_lam;
  }

  // VDI Turbulent: Re >= 10000
  function nuTurb(Re_val) {
    const f = xi(Re_val);
    const num = (f / 8) * Re_val * Pr;
    const den = 1 + 12.7 * Math.sqrt(f / 8) * (Math.pow(Pr, 2 / 3) - 1);
    const ent = 1 + Math.pow(d / L, 2 / 3);
    return (num / den) * ent * K_turb;
  }

  if (Re < 2300) {
    regime = 'Laminar';
    Nu = nuLam(Re);
  } else if (Re < 10000) {
    regime = 'Transition';
    const gamma = (Re - 2300) / (10000 - 2300);
    const Nu_lam = nuLam(2300);
    const Nu_turb = nuTurb(10000);
    Nu = (1 - gamma) * Nu_lam + gamma * Nu_turb;
  } else {
    regime = 'Turbulent';
    Nu = nuTurb(Re);
  }

  const h = Nu * props.lambda / d;
  const f_darcy = (Re >= 2300) ? xi(Math.max(Re, 10000)) : 64 / Re;
  const dP = f_darcy * (L / d) * 0.5 * props.rho * v * v;

  const items = [
    { label: 'Flow regime', value: regime, full: true },
    { label: 'Reynolds number Re', value: fmt(Re, 0) },
    { label: 'Prandtl number Pr', value: fmt(Pr, 3) },
    { label: 'Pr at wall Pr<sub>w</sub>', value: fmt(Pr_w, 3) },
    { label: 'Friction factor &xi;', value: fmtSci(f_darcy, 3) },
    { label: 'Correction K', value: fmt(regime === 'Laminar' ? K_lam : K_turb, 4) },
    { label: 'L/d ratio', value: fmt(L / d, 1) },
    { label: 'Nusselt number Nu', value: fmt(Nu, 2), highlight: true },
    { label: 'Heat transfer coeff. h', value: fmt(h, 1), unit: 'W/(m&sup2;&middot;K)', highlight: true },
    { label: 'Pressure drop &Delta;p', value: fmt(dP, 0), unit: 'Pa' }
  ];

  const grid = document.getElementById('fc-results-grid');
  grid.innerHTML = resultHTML(items);

  let note = `<strong>Correlation:</strong> `;
  if (regime === 'Laminar') note += `VDI G1 laminar (${bc === 'constT' ? 'const. T<sub>w</sub>' : 'const. q&#x0307;'}), Nu&#x0304; composite formula.`;
  else if (regime === 'Turbulent') note += `Gnielinski (VDI G1), valid for 10<sup>4</sup> &le; Re &le; 10<sup>6</sup>, 0.1 &le; Pr &le; 1000.`;
  else note += `VDI G1 transition interpolation between laminar (Re=2300) and turbulent (Re=10<sup>4</sup>).`;

  if (Re > 1e6) note += `<br><strong>Warning:</strong> Re &gt; 10<sup>6</sup>, outside validated range.`;
  if (Pr > 1000 || Pr < 0.1) note += `<br><strong>Warning:</strong> Pr outside validated range (0.1&ndash;1000).`;

  document.getElementById('fc-results-note').innerHTML = note;
  document.getElementById('fc-results').classList.add('show');
}

// =====================================================================
// FREE CONVECTION (VDI F2)
// =====================================================================

function toggleNCFields() {
  const geom = document.getElementById('nc-geom').value;
  const label = document.getElementById('nc-Lchar-label');
  if (geom === 'vert-plate') label.innerHTML = 'Height L <span class="unit">[m]</span>';
  else if (geom.startsWith('horiz-plate')) label.innerHTML = 'Char. length A/P <span class="unit">[m]</span>';
  else label.innerHTML = 'Outer diameter D <span class="unit">[m]</span>';
}

function calcFree() {
  const fluid = document.getElementById('nc-fluid').value;
  const Tf = parseFloat(document.getElementById('nc-Tf').value);
  const geom = document.getElementById('nc-geom').value;
  const Lc = parseFloat(document.getElementById('nc-Lchar').value);
  const Ts = parseFloat(document.getElementById('nc-Ts').value);
  const Tinf = parseFloat(document.getElementById('nc-Tinf').value);
  const dT = Math.abs(Ts - Tinf);

  let props;
  if (fluid === 'custom') {
    props = {
      rho: parseFloat(document.getElementById('nc-rho').value),
      cp: parseFloat(document.getElementById('nc-cp').value),
      lambda: parseFloat(document.getElementById('nc-lambda').value),
      mu: parseFloat(document.getElementById('nc-mu').value),
      Pr: parseFloat(document.getElementById('nc-Pr').value),
      beta: parseFloat(document.getElementById('nc-beta').value)
    };
    props.nu = props.mu / props.rho;
  } else {
    props = getFluidProps(fluid, Tf);
  }

  const g = 9.81;
  const Gr = g * props.beta * dT * Math.pow(Lc, 3) / Math.pow(props.nu, 2);
  const Ra = Gr * props.Pr;

  // VDI f1(Pr) function
  const f1 = Math.pow(1 + Math.pow(0.492 / props.Pr, 9 / 16), -16 / 9);

  let Nu, corrName;

  if (geom === 'vert-plate') {
    // Churchill & Chu (VDI F2)
    Nu = Math.pow(0.825 + 0.387 * Math.pow(Ra * f1, 1 / 6), 2);
    corrName = 'Churchill & Chu (vertical plate)';
  } else if (geom === 'horiz-cyl') {
    // Churchill & Chu for horizontal cylinder (VDI F2)
    const f1c = Math.pow(1 + Math.pow(0.559 / props.Pr, 9 / 16), -16 / 9);
    Nu = Math.pow(0.60 + 0.387 * Math.pow(Ra * f1c, 1 / 6), 2);
    corrName = 'Churchill & Chu (horizontal cylinder)';
  } else if (geom === 'horiz-plate-up') {
    // Hot side up or cold side down
    const RaF = Ra * f1;
    if (RaF <= 7e4) {
      Nu = 0.766 * Math.pow(RaF, 1 / 5);
    } else if (RaF <= 2e7) {
      Nu = 0.766 * Math.pow(RaF, 1 / 5);
    } else {
      Nu = 0.15 * Math.pow(RaF, 1 / 3);
    }
    Nu = Math.max(Nu, 0.6);
    corrName = 'VDI F2 horizontal plate (hot side up)';
  } else {
    // Hot side down or cold side up
    Nu = 0.6 * Math.pow(Ra * f1, 1 / 5);
    Nu = Math.max(Nu, 0.6);
    corrName = 'VDI F2 horizontal plate (hot side down)';
  }

  const h = Nu * props.lambda / Lc;

  const items = [
    { label: 'Grashof number Gr', value: fmtSci(Gr, 3) },
    { label: 'Rayleigh number Ra', value: fmtSci(Ra, 3) },
    { label: 'Prandtl number Pr', value: fmt(props.Pr, 3) },
    { label: 'f<sub>1</sub>(Pr)', value: fmt(f1, 4) },
    { label: '&Delta;T', value: fmt(dT, 1), unit: 'K' },
    { label: '&beta;', value: fmtSci(props.beta, 3), unit: '1/K' },
    { label: 'Nusselt number Nu', value: fmt(Nu, 2), highlight: true },
    { label: 'Heat transfer coeff. h', value: fmt(h, 2), unit: 'W/(m&sup2;&middot;K)', highlight: true }
  ];

  document.getElementById('nc-results-grid').innerHTML = resultHTML(items);

  let note = `<strong>Correlation:</strong> ${corrName}`;
  if (Ra < 0.1) note += '<br><strong>Note:</strong> Very low Ra; conduction dominates.';
  const RaFlow = (Ra > 1e9) ? ' (turbulent)' : ' (laminar)';
  note += `<br>Flow regime: Ra = ${fmtSci(Ra, 2)}${RaFlow}`;

  document.getElementById('nc-results-note').innerHTML = note;
  document.getElementById('nc-results').classList.add('show');
}

// =====================================================================
// CONDUCTION (VDI E)
// =====================================================================

function toggleCDFields() {
  const geom = document.getElementById('cd-geom').value;
  document.getElementById('cd-area-group').style.display = (geom === 'flat') ? '' : 'none';
  document.getElementById('cd-cyl-dims').style.display = (geom === 'cylinder') ? 'block' : 'none';
  document.getElementById('cd-sph-dims').style.display = (geom === 'sphere') ? 'block' : 'none';
}

function addLayer() {
  const container = document.getElementById('cd-layers');
  const n = container.children.length;
  const row = document.createElement('div');
  row.className = 'form-row layer-row';
  row.dataset.layer = n;
  row.innerHTML = `
    <div class="form-group">
      <label>Layer ${n + 1} thickness <span class="unit">[mm]</span></label>
      <input type="number" class="cd-layer-t" value="20" step="0.1">
    </div>
    <div class="form-group">
      <label>Layer ${n + 1} conductivity &lambda; <span class="unit">[W/(m&middot;K)]</span></label>
      <input type="number" class="cd-layer-k" value="0.04" step="0.001">
    </div>`;
  container.appendChild(row);
}

function removeLayer() {
  const container = document.getElementById('cd-layers');
  if (container.children.length > 1) container.removeChild(container.lastElementChild);
}

function calcConduction() {
  const geom = document.getElementById('cd-geom').value;
  const T1 = parseFloat(document.getElementById('cd-T1').value);
  const T2 = parseFloat(document.getElementById('cd-T2').value);
  const dT = T1 - T2;
  const hi = parseFloat(document.getElementById('cd-hi').value) || Infinity;
  const ho = parseFloat(document.getElementById('cd-ho').value) || Infinity;

  const thickInputs = document.querySelectorAll('.cd-layer-t');
  const kInputs = document.querySelectorAll('.cd-layer-k');
  const layers = [];
  for (let i = 0; i < thickInputs.length; i++) {
    layers.push({
      t: parseFloat(thickInputs[i].value) / 1000, // mm -> m
      k: parseFloat(kInputs[i].value)
    });
  }

  let Q, R_total, items = [];
  let interfaceTemps = [];

  if (geom === 'flat') {
    const A = parseFloat(document.getElementById('cd-A').value);
    // R = sum(t_i / (k_i * A)) + 1/(hi*A) + 1/(ho*A)
    let R_conv_i = (hi === Infinity) ? 0 : 1 / (hi * A);
    let R_conv_o = (ho === Infinity) ? 0 : 1 / (ho * A);
    let R_cond = 0;
    const R_layers = layers.map(l => l.t / (l.k * A));
    R_layers.forEach(r => R_cond += r);
    R_total = R_conv_i + R_cond + R_conv_o;
    Q = dT / R_total;

    // Interface temperatures
    let T_curr = T1;
    if (hi !== Infinity) {
      T_curr -= Q * R_conv_i;
      interfaceTemps.push({ name: 'Inner wall surface', T: T_curr });
    }
    for (let i = 0; i < layers.length; i++) {
      T_curr -= Q * R_layers[i];
      interfaceTemps.push({ name: i < layers.length - 1 ? `Interface ${i + 1}/${i + 2}` : 'Outer wall surface', T: T_curr });
    }

    const U = 1 / (R_total * A);
    items = [
      { label: 'Heat flow Q&#x0307;', value: fmt(Q, 2), unit: 'W', highlight: true },
      { label: 'Heat flux q&#x0307;', value: fmt(Q / A, 2), unit: 'W/m&sup2;', highlight: true },
      { label: 'Overall U-value', value: fmt(U, 3), unit: 'W/(m&sup2;&middot;K)' },
      { label: 'Total resistance R', value: fmtSci(R_total, 3), unit: 'K/W' }
    ];
    if (R_conv_i > 0) items.push({ label: 'R<sub>conv,inner</sub>', value: fmtSci(R_conv_i, 3), unit: 'K/W' });
    layers.forEach((l, i) => items.push({ label: `R<sub>layer ${i + 1}</sub> (${fmt(l.t * 1000, 1)} mm, &lambda;=${fmt(l.k, 3)})`, value: fmtSci(R_layers[i], 3), unit: 'K/W', full: true }));
    if (R_conv_o > 0) items.push({ label: 'R<sub>conv,outer</sub>', value: fmtSci(R_conv_o, 3), unit: 'K/W' });

  } else if (geom === 'cylinder') {
    const Lpipe = parseFloat(document.getElementById('cd-pipe-L').value);
    const ri = parseFloat(document.getElementById('cd-ri').value) / 1000;
    const PI2L = 2 * Math.PI * Lpipe;

    let r = ri;
    const R_layers = [];
    for (const l of layers) {
      const r_outer = r + l.t;
      R_layers.push(Math.log(r_outer / r) / (PI2L * l.k));
      r = r_outer;
    }
    const ro = r;

    const R_conv_i = (hi === Infinity) ? 0 : 1 / (hi * 2 * Math.PI * ri * Lpipe);
    const R_conv_o = (ho === Infinity) ? 0 : 1 / (ho * 2 * Math.PI * ro * Lpipe);
    let R_cond = 0;
    R_layers.forEach(rl => R_cond += rl);
    R_total = R_conv_i + R_cond + R_conv_o;
    Q = dT / R_total;

    // Interface temperatures
    let T_curr = T1;
    if (hi !== Infinity) { T_curr -= Q * R_conv_i; interfaceTemps.push({ name: 'Inner surface', T: T_curr }); }
    let r_curr = ri;
    for (let i = 0; i < layers.length; i++) {
      T_curr -= Q * R_layers[i];
      r_curr += layers[i].t;
      interfaceTemps.push({ name: `r = ${fmt(r_curr * 1000, 1)} mm`, T: T_curr });
    }

    const Ai = 2 * Math.PI * ri * Lpipe;
    const Ao = 2 * Math.PI * ro * Lpipe;

    items = [
      { label: 'Heat flow Q&#x0307;', value: fmt(Q, 2), unit: 'W', highlight: true },
      { label: 'q&#x0307;<sub>inner</sub>', value: fmt(Q / Ai, 2), unit: 'W/m&sup2;' },
      { label: 'q&#x0307;<sub>outer</sub>', value: fmt(Q / Ao, 2), unit: 'W/m&sup2;' },
      { label: 'Outer radius r<sub>o</sub>', value: fmt(ro * 1000, 2), unit: 'mm' },
      { label: 'Total resistance R', value: fmtSci(R_total, 3), unit: 'K/W' }
    ];
    if (R_conv_i > 0) items.push({ label: 'R<sub>conv,inner</sub>', value: fmtSci(R_conv_i, 3), unit: 'K/W' });
    layers.forEach((l, i) => {
      items.push({ label: `R<sub>layer ${i + 1}</sub>`, value: fmtSci(R_layers[i], 3), unit: 'K/W' });
    });
    if (R_conv_o > 0) items.push({ label: 'R<sub>conv,outer</sub>', value: fmtSci(R_conv_o, 3), unit: 'K/W' });

  } else { // sphere
    const ri = parseFloat(document.getElementById('cd-sri').value) / 1000;
    let r = ri;
    const R_layers = [];
    for (const l of layers) {
      const r_outer = r + l.t;
      R_layers.push((1 / r - 1 / r_outer) / (4 * Math.PI * l.k));
      r = r_outer;
    }
    const ro = r;

    const R_conv_i = (hi === Infinity) ? 0 : 1 / (hi * 4 * Math.PI * ri * ri);
    const R_conv_o = (ho === Infinity) ? 0 : 1 / (ho * 4 * Math.PI * ro * ro);
    let R_cond = 0;
    R_layers.forEach(rl => R_cond += rl);
    R_total = R_conv_i + R_cond + R_conv_o;
    Q = dT / R_total;

    items = [
      { label: 'Heat flow Q&#x0307;', value: fmt(Q, 2), unit: 'W', highlight: true },
      { label: 'Outer radius r<sub>o</sub>', value: fmt(ro * 1000, 2), unit: 'mm' },
      { label: 'Total resistance R', value: fmtSci(R_total, 3), unit: 'K/W' }
    ];
    layers.forEach((l, i) => {
      items.push({ label: `R<sub>layer ${i + 1}</sub>`, value: fmtSci(R_layers[i], 3), unit: 'K/W' });
    });
  }

  // Add interface temperatures
  interfaceTemps.forEach(it => {
    items.push({ label: `T @ ${it.name}`, value: fmt(it.T, 1), unit: '&deg;C' });
  });

  document.getElementById('cd-results-grid').innerHTML = resultHTML(items);
  document.getElementById('cd-results-note').innerHTML =
    `<strong>Geometry:</strong> ${geom === 'flat' ? 'Plane wall' : geom === 'cylinder' ? 'Cylindrical shell' : 'Spherical shell'}, ` +
    `${layers.length} layer(s). Steady-state conduction (VDI E).`;
  document.getElementById('cd-results').classList.add('show');
}

// =====================================================================
// RADIATION (VDI K)
// =====================================================================

function toggleRDFields() {
  const config = document.getElementById('rd-config').value;
  const eps2Group = document.getElementById('rd-eps2-group');
  const f12Group = document.getElementById('rd-F12-group');

  if (config === 'single') {
    eps2Group.style.display = 'none';
    f12Group.style.display = 'none';
  } else if (config === 'enclosed') {
    eps2Group.style.display = 'none';
    f12Group.style.display = 'none';
  } else if (config === 'parallel') {
    eps2Group.style.display = '';
    f12Group.style.display = 'none';
  } else {
    eps2Group.style.display = '';
    f12Group.style.display = '';
  }
}

function calcRadiation() {
  const sigma = 5.670374419e-8; // Stefan-Boltzmann constant
  const config = document.getElementById('rd-config').value;
  const T1_C = parseFloat(document.getElementById('rd-T1').value);
  const T2_C = parseFloat(document.getElementById('rd-T2').value);
  const eps1 = parseFloat(document.getElementById('rd-eps1').value);
  const eps2 = parseFloat(document.getElementById('rd-eps2').value) || 1;
  const A1 = parseFloat(document.getElementById('rd-A1').value);
  const F12 = parseFloat(document.getElementById('rd-F12').value) || 1;

  const T1 = T1_C + 273.15;
  const T2 = T2_C + 273.15;
  const T14 = Math.pow(T1, 4);
  const T24 = Math.pow(T2, 4);

  let Q, eps_eff, corrName;

  if (config === 'single') {
    // Q = eps1 * sigma * A * (T1^4 - T2^4)
    eps_eff = eps1;
    Q = eps1 * sigma * A1 * (T14 - T24);
    corrName = 'Single grey surface to black surroundings';
  } else if (config === 'parallel') {
    // Q = sigma * A * (T1^4 - T2^4) / (1/eps1 + 1/eps2 - 1)
    eps_eff = 1 / (1 / eps1 + 1 / eps2 - 1);
    Q = eps_eff * sigma * A1 * (T14 - T24);
    corrName = 'Two infinite parallel grey plates';
  } else if (config === 'enclosed') {
    // Small body (1) enclosed by large body (2), A1 << A2
    // Q = eps1 * sigma * A1 * (T1^4 - T2^4)
    eps_eff = eps1;
    Q = eps1 * sigma * A1 * (T14 - T24);
    corrName = 'Small body enclosed by large surface (A<sub>1</sub> &lt;&lt; A<sub>2</sub>)';
  } else {
    // Arbitrary: Q = eps_eff * sigma * A1 * F12 * (T1^4 - T2^4)
    // For grey surfaces with view factor:
    // 1/eps_eff = 1/eps1 + (A1*F12)*(1/eps2 - 1)/A1  (simplified for A1=A2)
    // More general: Q = sigma*(T1^4-T2^4) / (1/(eps1*A1) + 1/(A1*F12) - 1/A1 + 1/(eps2*A1) - 1/A1)
    // Simplified for two surfaces: use radiosity method
    // For engineering: Q = A1 * F12 * eps_eff * sigma * (T1^4 - T2^4)
    eps_eff = 1 / (1 / eps1 + 1 / eps2 - 1); // surface resistance combination
    Q = A1 * F12 * eps_eff * sigma * (T14 - T24);
    corrName = 'Two grey surfaces with view factor';
  }

  const q = Q / A1;
  const Eb1 = sigma * T14;
  const Eb2 = sigma * T24;

  // Radiation heat transfer coefficient
  const h_rad = (T1 !== T2) ? Q / (A1 * (T1_C - T2_C)) : 0;

  const items = [
    { label: 'Net heat flow Q&#x0307;<sub>12</sub>', value: fmt(Q, 2), unit: 'W', highlight: true },
    { label: 'Heat flux q&#x0307;', value: fmt(q, 2), unit: 'W/m&sup2;', highlight: true },
    { label: 'Radiation h<sub>rad</sub>', value: fmt(h_rad, 2), unit: 'W/(m&sup2;&middot;K)' },
    { label: 'Effective emissivity &epsilon;<sub>eff</sub>', value: fmt(eps_eff, 4) },
    { label: 'E<sub>b,1</sub> = &sigma;T<sub>1</sub>&sup4;', value: fmt(Eb1, 1), unit: 'W/m&sup2;' },
    { label: 'E<sub>b,2</sub> = &sigma;T<sub>2</sub>&sup4;', value: fmt(Eb2, 1), unit: 'W/m&sup2;' },
    { label: 'T<sub>1</sub>', value: fmt(T1, 2), unit: 'K' },
    { label: 'T<sub>2</sub>', value: fmt(T2, 2), unit: 'K' },
    { label: '&sigma; (Stefan-Boltzmann)', value: '5.670 &times; 10<sup>-8</sup>', unit: 'W/(m&sup2;&middot;K&sup4;)', full: true }
  ];

  document.getElementById('rd-results-grid').innerHTML = resultHTML(items);
  document.getElementById('rd-results-note').innerHTML =
    `<strong>Configuration:</strong> ${corrName}.<br>&sigma; = 5.670374419 &times; 10<sup>-8</sup> W/(m&sup2;&middot;K&sup4;) (CODATA 2018).`;
  document.getElementById('rd-results').classList.add('show');
}

// =====================================================================
// HEAT EXCHANGER (VDI C / D)
// =====================================================================

function toggleHXFields() {
  const mode = document.getElementById('hx-mode').value;
  const aGroup = document.getElementById('hx-A-group');
  const thoGroup = document.getElementById('hx-Tho-group');
  const tcoGroup = document.getElementById('hx-Tco-group');

  if (mode === 'design') {
    // Know all temps, find A
    aGroup.style.display = 'none';
    thoGroup.style.display = '';
    tcoGroup.style.display = '';
  } else if (mode === 'rating') {
    // Know A, U, inlet temps, find outlet temps
    aGroup.style.display = '';
    thoGroup.style.display = 'none';
    tcoGroup.style.display = 'none';
  } else {
    // Performance check: all known
    aGroup.style.display = '';
    thoGroup.style.display = '';
    tcoGroup.style.display = '';
  }
}

// ---- LMTD helpers ----

function lmtd(dT1, dT2) {
  if (Math.abs(dT1 - dT2) < 0.001) return dT1;
  if (dT1 <= 0 || dT2 <= 0) return NaN;
  return (dT1 - dT2) / Math.log(dT1 / dT2);
}

// F-correction factor for shell-and-tube 1-2n (VDI C1)
function Fcorr_shell(R, P, nShellPasses) {
  // Single shell pass F-factor (TEMA E, 1-2 or 1-4)
  if (P < 1e-10) return 1;
  if (Math.abs(R - 1) < 1e-6) {
    // Special case R = 1
    const s = P * Math.SQRT2;
    const num = s;
    const den = (1 - P) * Math.log((2 - P * (2 - Math.SQRT2)) / (2 - P * (2 + Math.SQRT2)));
    return Math.abs(den) < 1e-10 ? 1 : num / den;
  }
  const S = Math.sqrt(R * R + 1);
  const num = S * Math.log((1 - P) / (1 - R * P));
  const a = 2 / P - 1 - R + S;
  const b = 2 / P - 1 - R - S;
  const den = (R - 1) * Math.log(a / b);
  if (Math.abs(den) < 1e-10 || a / b <= 0) return NaN;
  let F1 = num / den;

  if (nShellPasses && nShellPasses > 1) {
    // For n shell passes: convert P to P1 for single shell
    // Using the relation for n identical shell passes in series
    // This effectively raises the F-factor
    // Approximate: use the single-shell F with effective P
    // P_eff for n shells: P_n = ((1-R*P1)/(1-P1))^n ...
    // Already handled at the calling level by converting P
    return F1;
  }
  return Math.min(F1, 1);
}

// F-factor for crossflow configurations (approximate - from analytical fits)
function Fcorr_cross(R, P) {
  if (P < 1e-10) return 1;
  // Use numerical approximation for crossflow F-factor (Bowman, Mueller, Nagle)
  // For both unmixed: use series approximation
  // For practical engineering: F is close to 1 for most cases
  // Precise computation requires iterative solution
  // Use the approximation: F ≈ LMTD_cross / LMTD_counter
  // For now, return a computed value using the NTU approach
  return null; // Will use NTU method directly for crossflow
}

// ---- epsilon-NTU relations (VDI C3) ----

function epsFromNTU(NTU, Cr, config) {
  // Cr = Cmin/Cmax, NTU = U*A/Cmin
  if (Cr < 1e-10) {
    // One fluid condensing/evaporating (Cr → 0)
    return 1 - Math.exp(-NTU);
  }
  switch (config) {
    case 'counter':
      if (Math.abs(Cr - 1) < 1e-6)
        return NTU / (1 + NTU);
      return (1 - Math.exp(-NTU * (1 - Cr))) / (1 - Cr * Math.exp(-NTU * (1 - Cr)));

    case 'parallel':
      return (1 - Math.exp(-NTU * (1 + Cr))) / (1 + Cr);

    case 'cross-UU': {
      // Both fluids unmixed (Kays & London / VDI approx)
      const n = Math.pow(NTU, 0.22);
      return 1 - Math.exp((n / Cr) * (Math.exp(-Cr * Math.pow(NTU, 0.78)) - 1));
    }
    case 'cross-MU': {
      // Cmax mixed, Cmin unmixed
      return (1 / Cr) * (1 - Math.exp(-Cr * (1 - Math.exp(-NTU))));
    }
    case 'cross-UM': {
      // Cmin mixed, Cmax unmixed
      return 1 - Math.exp(-(1 / Cr) * (1 - Math.exp(-Cr * NTU)));
    }
    case 'shell-1-2':
    case 'shell-1-4': {
      // 1 shell pass, even number of tube passes
      const E = Math.sqrt(1 + Cr * Cr);
      const expE = Math.exp(-NTU * E);
      return 2 / (1 + Cr + E * (1 + expE) / (1 - expE));
    }
    default:
      return NaN;
  }
}

function NTUfromEps(eps, Cr, config) {
  if (eps <= 0) return 0;
  if (Cr < 1e-10) return -Math.log(1 - eps);

  switch (config) {
    case 'counter':
      if (Math.abs(Cr - 1) < 1e-6)
        return eps / (1 - eps);
      return (1 / (Cr - 1)) * Math.log((eps - 1) / (eps * Cr - 1));

    case 'parallel':
      return -Math.log(1 - eps * (1 + Cr)) / (1 + Cr);

    default: {
      // Numerical inversion for crossflow and shell-and-tube
      let lo = 0, hi = 50, mid;
      for (let i = 0; i < 60; i++) {
        mid = (lo + hi) / 2;
        if (epsFromNTU(mid, Cr, config) < eps) lo = mid;
        else hi = mid;
      }
      return mid;
    }
  }
}

function calcHX() {
  const mode = document.getElementById('hx-mode').value;
  const config = document.getElementById('hx-config').value;
  const Thi = parseFloat(document.getElementById('hx-Thi').value);
  const Tci = parseFloat(document.getElementById('hx-Tci').value);
  const Ch = parseFloat(document.getElementById('hx-Ch').value);
  const Cc = parseFloat(document.getElementById('hx-Cc').value);
  const U_clean = parseFloat(document.getElementById('hx-U').value);
  const Rf = parseFloat(document.getElementById('hx-Rf').value) || 0;

  // Effective U with fouling
  const U = (Rf > 0) ? 1 / (1 / U_clean + Rf) : U_clean;

  const Cmin = Math.min(Ch, Cc);
  const Cmax = Math.max(Ch, Cc);
  const Cr = Cmin / Cmax;
  const Qmax = Cmin * (Thi - Tci);

  let Q, eps, NTU, A, Tho, Tco, LMTD_val, F;
  let items = [];

  if (mode === 'design') {
    // All temps known → find A
    Tho = parseFloat(document.getElementById('hx-Tho').value);
    Tco = parseFloat(document.getElementById('hx-Tco').value);

    const Qh = Ch * (Thi - Tho);
    const Qc = Cc * (Tco - Tci);
    Q = (Qh + Qc) / 2; // average (should be equal by energy balance)

    if (Math.abs(Qh - Qc) / Math.max(Qh, Qc) > 0.05) {
      // Energy balance doesn't close
      items.push({ label: 'Energy balance warning', value: `Q<sub>h</sub>=${fmt(Qh,0)}W, Q<sub>c</sub>=${fmt(Qc,0)}W`, full: true });
    }

    eps = Q / Qmax;

    // LMTD for counterflow reference
    const dT1_cf = Thi - Tco;
    const dT2_cf = Tho - Tci;
    const LMTD_cf = lmtd(dT1_cf, dT2_cf);

    // NTU from epsilon
    NTU = NTUfromEps(eps, Cr, config);
    A = NTU * Cmin / U;

    // F-factor: F = Q / (U * A * LMTD_counterflow)
    // But A * U = NTU * Cmin, so F = Q / (NTU * Cmin * LMTD_cf)
    LMTD_val = LMTD_cf;
    F = (isFinite(LMTD_cf) && LMTD_cf > 0) ? Q / (U * A * LMTD_cf) : NaN;
    // More properly: the effective LMTD = F * LMTD_counterflow
    // so A = Q / (U * F * LMTD_cf)
    // Let's recalculate A using the LMTD approach for configurations that support F
    if (config === 'counter') {
      F = 1.0;
      LMTD_val = LMTD_cf;
      A = Q / (U * LMTD_cf);
    } else if (config === 'parallel') {
      const dT1_p = Thi - Tci;
      const dT2_p = Tho - Tco;
      LMTD_val = lmtd(dT1_p, dT2_p);
      F = 1.0; // LMTD already for parallel
      A = Q / (U * LMTD_val);
    } else if (config.startsWith('shell')) {
      const R = (Math.abs(Tco - Tci) > 0.01) ? (Thi - Tho) / (Tco - Tci) : 1e10;
      const P = (Math.abs(Thi - Tci) > 0.01) ? (Tco - Tci) / (Thi - Tci) : 0;
      F = Fcorr_shell(R, P, config === 'shell-1-4' ? 2 : 1);
      if (isFinite(F) && F > 0) {
        A = Q / (U * F * LMTD_cf);
      }
      LMTD_val = LMTD_cf;
    } else {
      // Crossflow: use NTU-derived area (F from back-calculation)
      F = (isFinite(LMTD_cf) && LMTD_cf > 0 && A > 0) ? Q / (U * A * LMTD_cf) : NaN;
      LMTD_val = LMTD_cf;
    }

    items = [
      { label: 'Heat duty Q&#x0307;', value: fmt(Q, 0), unit: 'W', highlight: true },
      { label: 'Required area A', value: fmt(A, 2), unit: 'm&sup2;', highlight: true },
      { label: 'Effectiveness &epsilon;', value: fmt(eps, 4) },
      { label: 'NTU', value: fmt(NTU, 3) },
      { label: 'LMTD (counterflow ref.)', value: fmt(LMTD_cf, 2), unit: 'K' },
      { label: 'F-correction factor', value: isFinite(F) ? fmt(F, 4) : 'N/A' },
      { label: 'Effective &Delta;T<sub>m</sub>', value: isFinite(F) ? fmt(F * LMTD_cf, 2) : fmt(Q / (U * A), 2), unit: 'K' },
      { label: 'C<sub>r</sub> = C<sub>min</sub>/C<sub>max</sub>', value: fmt(Cr, 4) },
      { label: 'C<sub>min</sub>', value: fmt(Cmin, 0), unit: 'W/K' },
      { label: 'Q<sub>max</sub>', value: fmt(Qmax, 0), unit: 'W' }
    ];

  } else if (mode === 'rating') {
    // Know A, U, Thi, Tci, Ch, Cc → find outlet temps
    A = parseFloat(document.getElementById('hx-A').value);
    NTU = U * A / Cmin;
    eps = epsFromNTU(NTU, Cr, config);
    Q = eps * Qmax;
    Tho = Thi - Q / Ch;
    Tco = Tci + Q / Cc;

    const dT1_cf = Thi - Tco;
    const dT2_cf = Tho - Tci;
    const LMTD_cf = lmtd(dT1_cf, dT2_cf);

    F = (LMTD_cf > 0) ? Q / (U * A * LMTD_cf) : NaN;

    items = [
      { label: 'Heat duty Q&#x0307;', value: fmt(Q, 0), unit: 'W', highlight: true },
      { label: 'T<sub>h,out</sub>', value: fmt(Tho, 1), unit: '&deg;C', highlight: true },
      { label: 'T<sub>c,out</sub>', value: fmt(Tco, 1), unit: '&deg;C', highlight: true },
      { label: 'Effectiveness &epsilon;', value: fmt(eps, 4) },
      { label: 'NTU', value: fmt(NTU, 3) },
      { label: 'LMTD (counterflow ref.)', value: fmt(LMTD_cf, 2), unit: 'K' },
      { label: 'F-correction factor', value: isFinite(F) ? fmt(F, 4) : 'N/A' },
      { label: 'C<sub>r</sub>', value: fmt(Cr, 4) },
      { label: 'C<sub>min</sub>', value: fmt(Cmin, 0), unit: 'W/K' },
      { label: 'Q<sub>max</sub>', value: fmt(Qmax, 0), unit: 'W' }
    ];

  } else {
    // Performance check: all temps and area known
    Tho = parseFloat(document.getElementById('hx-Tho').value);
    Tco = parseFloat(document.getElementById('hx-Tco').value);
    A = parseFloat(document.getElementById('hx-A').value);

    const Qh = Ch * (Thi - Tho);
    const Qc = Cc * (Tco - Tci);
    Q = (Qh + Qc) / 2;
    eps = Q / Qmax;
    NTU = U * A / Cmin;
    const eps_calc = epsFromNTU(NTU, Cr, config);

    const dT1_cf = Thi - Tco;
    const dT2_cf = Tho - Tci;
    const LMTD_cf = lmtd(dT1_cf, dT2_cf);
    F = (LMTD_cf > 0 && A > 0) ? Q / (U * A * LMTD_cf) : NaN;

    // Back-calculate effective U from actual temperatures
    const U_eff = (A > 0 && LMTD_cf > 0 && isFinite(F) && F > 0) ? Q / (A * F * LMTD_cf) : Q / (A * LMTD_cf);

    items = [
      { label: 'Q&#x0307; (from temps)', value: fmt(Q, 0), unit: 'W', highlight: true },
      { label: '&epsilon; (actual)', value: fmt(eps, 4), highlight: true },
      { label: '&epsilon; (from NTU)', value: fmt(eps_calc, 4) },
      { label: 'Q<sub>h</sub> = C<sub>h</sub>&middot;&Delta;T<sub>h</sub>', value: fmt(Qh, 0), unit: 'W' },
      { label: 'Q<sub>c</sub> = C<sub>c</sub>&middot;&Delta;T<sub>c</sub>', value: fmt(Qc, 0), unit: 'W' },
      { label: 'Energy balance error', value: fmt(Math.abs(Qh - Qc) / Math.max(Math.abs(Qh), Math.abs(Qc)) * 100, 1), unit: '%' },
      { label: 'NTU', value: fmt(NTU, 3) },
      { label: 'LMTD (counterflow)', value: fmt(LMTD_cf, 2), unit: 'K' },
      { label: 'F-factor', value: isFinite(F) ? fmt(F, 4) : 'N/A' },
      { label: 'C<sub>r</sub>', value: fmt(Cr, 4) },
      { label: 'U<sub>eff</sub> (back-calc)', value: fmt(U_eff, 1), unit: 'W/(m&sup2;&middot;K)' },
      { label: 'Q<sub>max</sub>', value: fmt(Qmax, 0), unit: 'W' }
    ];
  }

  // Add fouling info
  if (Rf > 0) {
    items.push({ label: 'U<sub>clean</sub>', value: fmt(U_clean, 1), unit: 'W/(m&sup2;&middot;K)' });
    items.push({ label: 'U<sub>fouled</sub>', value: fmt(U, 1), unit: 'W/(m&sup2;&middot;K)' });
    items.push({ label: 'R<sub>fouling</sub>', value: fmtSci(Rf, 2), unit: 'm&sup2;&middot;K/W' });
  }

  document.getElementById('hx-results-grid').innerHTML = resultHTML(items);

  // Build note
  const configNames = {
    'counter': 'Counterflow', 'parallel': 'Parallel flow',
    'cross-UU': 'Crossflow (both unmixed)', 'cross-MU': 'Crossflow (C<sub>max</sub> mixed)',
    'cross-UM': 'Crossflow (C<sub>min</sub> mixed)',
    'shell-1-2': 'Shell & tube 1-2 (TEMA E)', 'shell-1-4': 'Shell & tube 1-4'
  };
  const modeNames = { 'design': 'Design (sizing)', 'rating': 'Rating (performance)', 'check': 'Performance check' };
  let note = `<strong>${modeNames[mode]}</strong> &mdash; ${configNames[config]}`;
  note += `<br>Method: &epsilon;-NTU (VDI C3) with LMTD cross-check.`;

  if (isFinite(F) && F < 0.75) {
    note += `<br><strong>Warning:</strong> F = ${fmt(F, 3)} &lt; 0.75. This configuration is inefficient; consider using more shell passes or a different arrangement.`;
  }
  if (eps > 0.95) {
    note += `<br><strong>Note:</strong> &epsilon; &gt; 0.95 &mdash; approaching thermodynamic limit; verify feasibility.`;
  }
  if (config === 'parallel' && eps > 1 / (1 + Cr)) {
    note += `<br><strong>Warning:</strong> Requested &epsilon; exceeds parallel-flow limit of ${fmt(1/(1+Cr), 3)}.`;
  }

  document.getElementById('hx-results-note').innerHTML = note;
  document.getElementById('hx-results').classList.add('show');
}

// =====================================================================
// PWA SERVICE WORKER REGISTRATION
// =====================================================================

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
