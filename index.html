<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#09090b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="EngCalc">
<meta name="description" content="40+ native engineering calculators for mechanical design, tribology, bearings, fatigue, heat transfer, and more.">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="icons/icon.svg">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>Engineering Calculators PWA</title>
<style>
:root {
  --sidebar-w: 300px;
  --header-h: 56px;
  --bg: #09090b;
  --sidebar-bg: #18181b;
  --sidebar-hover: #27272a;
  --sidebar-active: rgba(245,158,11,0.15);
  --accent: #f59e0b;
  --accent-light: #fbbf24;
  --text: #f4f4f5;
  --text-muted: #a1a1aa;
  --card-bg: #18181b;
  --card-border: #3f3f46;
  --input-bg: #27272a;
  --input-border: #3f3f46;
  --output-bg: #052e16;
  --output-border: #22c55e;
  --cat-contact: #3b82f6;
  --cat-bearing-roll: #22c55e;
  --cat-bearing-hydro: #06b6d4;
  --cat-bearing-air: #8b5cf6;
  --cat-shaft: #f59e0b;
  --cat-fastener: #ef4444;
  --cat-fatigue: #ec4899;
  --cat-fluid: #6366f1;
  --cat-dynamics: #14b8a6;
  --cat-power: #f97316;
  --cat-material: #a855f7;
  --cat-heat: #e11d48;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); overflow: hidden; height: 100vh; width: 100vw; }

/* HEADER */
.header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-h); background: #18181b; display: flex; align-items: center; padding: 0 16px; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.4); border-bottom: 1px solid #3f3f46; }
.menu-btn { width: 40px; height: 40px; background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: background .15s; flex-shrink: 0; }
.menu-btn:hover { background: rgba(255,255,255,.1); }
.menu-btn svg { width: 24px; height: 24px; }
.header-title { color: white; font-size: 1.1rem; font-weight: 600; margin-left: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-subtitle { color: rgba(255,255,255,.6); font-size: .8rem; margin-left: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
.header-badge { background: rgba(255,255,255,.15); color: rgba(255,255,255,.8); font-size: .7rem; padding: 3px 10px; border-radius: 12px; white-space: nowrap; }

/* SIDEBAR */
.sidebar { position: fixed; top: var(--header-h); left: 0; bottom: 0; width: var(--sidebar-w); background: var(--sidebar-bg); overflow-y: auto; overflow-x: hidden; z-index: 90; transition: transform .25s cubic-bezier(.4,0,.2,1); scrollbar-width: thin; scrollbar-color: #3f3f46 transparent; }
.sidebar::-webkit-scrollbar { width: 6px; }
.sidebar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
.sidebar.collapsed { transform: translateX(-100%); }
.sidebar-search { padding: 12px 14px 8px; position: sticky; top: 0; background: var(--sidebar-bg); z-index: 5; }
.sidebar-search input { width: 100%; padding: 8px 12px 8px 36px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.1); border-radius: 8px; color: var(--text); font-size: .85rem; outline: none; transition: border-color .15s; }
.sidebar-search input::placeholder { color: var(--text-muted); }
.sidebar-search input:focus { border-color: var(--accent); background: rgba(255,255,255,.12); }
.search-icon { position: absolute; left: 26px; top: 22px; width: 16px; height: 16px; color: var(--text-muted); pointer-events: none; }
.cat-group { margin-bottom: 4px; }
.cat-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px 6px; cursor: pointer; user-select: none; }
.cat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.cat-label { font-size: .7rem; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; color: var(--text-muted); }
.cat-toggle { margin-left: auto; color: var(--text-muted); transition: transform .2s; width: 14px; height: 14px; }
.cat-header.collapsed .cat-toggle { transform: rotate(-90deg); }
.cat-items { overflow: hidden; }
.cat-header.collapsed + .cat-items { display: none; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 14px 8px 32px; cursor: pointer; color: var(--text); font-size: .85rem; transition: background .12s; border-left: 3px solid transparent; text-decoration: none; }
.nav-item:hover { background: var(--sidebar-hover); }
.nav-item.active { background: var(--sidebar-active); border-left-color: var(--accent-light); color: white; }
.nav-code { font-family: 'SF Mono','Fira Code',monospace; font-size: .7rem; color: var(--accent-light); background: rgba(245,158,11,.15); padding: 1px 6px; border-radius: 4px; flex-shrink: 0; }
.nav-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* MAIN */
.main { position: fixed; top: var(--header-h); bottom: 0; left: var(--sidebar-w); right: 0; transition: left .25s cubic-bezier(.4,0,.2,1); background: var(--bg); overflow-y: auto; }
.main.expanded { left: 0; }

/* WELCOME */
.welcome { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; padding: 32px; text-align: center; }
.welcome.hidden { display: none; }
.welcome-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #92400e, #f59e0b); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(245,158,11,.25); }
.welcome-icon svg { width: 40px; height: 40px; color: white; }
.welcome h2 { font-size: 1.6rem; color: #f4f4f5; margin-bottom: 8px; }
.welcome p { color: #a1a1aa; max-width: 480px; font-size: .95rem; line-height: 1.6; }
.quick-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 28px; max-width: 640px; width: 100%; }
.quick-card { background: #18181b; border-radius: 10px; padding: 14px; cursor: pointer; text-align: center; border: 1px solid #3f3f46; transition: box-shadow .15s, transform .1s, border-color .15s; }
.quick-card:hover { box-shadow: 0 4px 12px rgba(245,158,11,.1); transform: translateY(-2px); border-color: #f59e0b; }
.quick-card .qc-icon { font-size: 1.3rem; margin-bottom: 6px; }
.quick-card .qc-label { font-size: .78rem; color: #a1a1aa; font-weight: 500; }

/* CALCULATOR PANELS */
.calc-panel { display: none; padding: 24px; max-width: 860px; margin: 0 auto; }
.calc-panel.active { display: block; }
.calc-title { font-size: 1.3rem; font-weight: 700; color: #f4f4f5; margin-bottom: 4px; }
.calc-desc { color: #a1a1aa; font-size: .9rem; margin-bottom: 20px; line-height: 1.5; }
.calc-section { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
.calc-section h3 { font-size: .85rem; font-weight: 700; color: #a1a1aa; text-transform: uppercase; letter-spacing: .04em; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
.calc-section h3 .dot { width: 8px; height: 8px; border-radius: 50%; }
.input-dot { background: var(--accent); }
.output-dot { background: #22c55e; }
.formula-dot { background: #a855f7; }

.field-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
.field { display: flex; flex-direction: column; }
.field label { font-size: .78rem; color: #a1a1aa; margin-bottom: 4px; font-weight: 500; }
.field label .unit { color: #71717a; font-weight: 400; }
.field input, .field select { padding: 8px 10px; border: 1px solid var(--input-border); border-radius: 6px; font-size: .9rem; background: var(--input-bg); color: #f4f4f5; outline: none; transition: border-color .15s; }
.field input:focus, .field select:focus { border-color: var(--accent); }
.field input[readonly] { background: var(--output-bg); border-color: var(--output-border); color: #4ade80; font-weight: 600; cursor: default; }
.field input.warn { background: rgba(239,68,68,0.1); border-color: #ef4444; color: #fca5a5; }

.calc-btn { display: inline-flex; align-items: center; gap: 8px; background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: background .15s; margin-top: 8px; }
.calc-btn:hover { background: #d97706; }
.formula-box { background: rgba(168,85,247,0.08); border: 1px solid rgba(124,58,237,0.25); border-radius: 8px; padding: 14px 16px; margin-top: 12px; font-family: 'SF Mono','Fira Code',monospace; font-size: .82rem; color: #c4b5fd; line-height: 1.7; white-space: pre-wrap; overflow-x: auto; }

/* OVERLAY (mobile) */
.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 85; display: none; cursor: pointer; }

/* RESPONSIVE */
@media (max-width: 768px) {
  :root { --sidebar-w: 280px; }
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; }
  .main { left: 0 !important; }
  .header-subtitle { display: none; }
  .field-grid { grid-template-columns: 1fr; }
}

/* REFERENCE TABLE */
.ref-table { width: 100%; border-collapse: collapse; font-size: .82rem; margin-top: 8px; }
.ref-table th { background: #27272a; text-align: left; padding: 6px 10px; border-bottom: 2px solid #3f3f46; font-weight: 600; color: #a1a1aa; white-space: nowrap; }
.ref-table td { padding: 5px 10px; border-bottom: 1px solid #3f3f46; color: #d4d4d8; }
.ref-table tr:hover td { background: #27272a; }

/* INSTALL BANNER */
.install-banner { display: none; align-items: center; gap: 12px; background: #27272a; padding: 10px 16px; position: fixed; top: var(--header-h); left: 0; right: 0; z-index: 95; border-bottom: 1px solid #3f3f46; }
.install-banner.show { display: flex; }
.install-banner p { color: white; font-size: .85rem; flex: 1; }
.install-btn { background: var(--accent); color: white; border: none; padding: 6px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: .82rem; }
.install-dismiss { background: none; border: none; color: rgba(255,255,255,.6); cursor: pointer; font-size: 1.2rem; padding: 4px; }

/* HEAT TRANSFER CALCULATOR STYLES */
.ht-results { background: linear-gradient(135deg,rgba(245,158,11,.06),rgba(245,158,11,.02)); border: 1px solid rgba(245,158,11,.25); border-radius: 8px; padding: 16px; margin-top: 12px; display: none; }
.ht-results.show { display: block; animation: htFadeIn .3s ease; }
@keyframes htFadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }
.ht-results h3 { color: var(--accent); font-size: .85rem; font-weight: 700; text-transform: uppercase; letter-spacing: .04em; margin-bottom: 10px; }
.ht-result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.ht-result-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 8px; border-radius: 4px; background: rgba(0,0,0,.2); font-size: .82rem; }
.ht-result-item .lbl { color: var(--text-muted); }
.ht-result-item .val { font-family: 'SF Mono','Fira Code',monospace; font-weight: 600; color: var(--text); }
.ht-result-item .val .unit { font-size: .72rem; color: var(--text-muted); font-weight: 400; margin-left: 3px; }
.ht-result-item.highlight { background: rgba(245,158,11,.15); border: 1px solid rgba(245,158,11,.3); }
.ht-result-item.highlight .val { color: var(--accent); }
.ht-result-item.full { grid-column: 1 / -1; }
.ht-result-note { font-size: .75rem; color: var(--text-muted); margin-top: 10px; padding: 8px; background: rgba(245,158,11,.08); border-radius: 4px; border-left: 3px solid var(--accent); line-height: 1.5; }
.ht-props-display { display: grid; grid-template-columns: repeat(auto-fill,minmax(130px,1fr)); gap: 5px; margin: 8px 0 12px; padding: 8px; background: rgba(0,0,0,.15); border-radius: 6px; }
.ht-prop-chip { font-family: 'SF Mono','Fira Code',monospace; font-size: .72rem; padding: 3px 6px; border-radius: 4px; background: var(--input-bg); display: flex; justify-content: space-between; gap: 6px; }
.ht-prop-chip .pk { color: var(--text-muted); }
.ht-prop-chip .pv { color: var(--accent); font-weight: 600; }
.ht-sep { border: none; border-top: 1px solid var(--card-border); margin: 12px 0; }
.ht-info-tag { display: inline-block; font-size: .68rem; padding: 2px 8px; border-radius: 4px; background: rgba(225,29,72,.12); color: #fb7185; margin-left: 8px; font-weight: 400; }
.ht-btn-row { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
.ht-btn-outline { display: inline-flex; align-items: center; gap: 6px; background: transparent; color: var(--text-muted); border: 1px solid var(--card-border); padding: 6px 12px; border-radius: 6px; font-size: .8rem; cursor: pointer; transition: border-color .15s, color .15s; }
.ht-btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.ht-btn-sm { font-size: .75rem; padding: 4px 10px; }
.ht-section-label { font-size: .82rem; font-weight: 700; color: var(--text-muted); margin: 12px 0 6px; }
@media (max-width: 768px) { .ht-result-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header class="header">
  <button class="menu-btn" id="menuBtn" aria-label="Toggle sidebar">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <span class="header-title" id="headerTitle">Engineering Calculators</span>
  <span class="header-subtitle" id="headerSub">Tribology &amp; Machine Design</span>
  <div class="header-right"><span class="header-badge">40+ native calcs</span></div>
</header>

<div class="install-banner" id="installBanner">
  <p>Install this app for quick access</p>
  <button class="install-btn" id="installBtn">Install</button>
  <button class="install-dismiss" id="installDismiss">&times;</button>
</div>

<div class="sidebar-overlay" id="sidebarOverlay"></div>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-search">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input type="text" id="searchInput" placeholder="Search calculators... (Ctrl+K)" autocomplete="off">
  </div>
  <div id="navList"></div>
</nav>

<div class="main" id="main">
  <div class="welcome" id="welcome">
    <div class="welcome-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    </div>
    <h2>Engineering Calculators</h2>
    <p>40+ native mechanical engineering calculators. All calculations run locally in your browser â€” no server needed, works offline.</p>
    <div class="quick-grid" id="quickGrid"></div>
  </div>
  <div id="calcContainer"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENGINEERING CONSTANTS & MATERIAL DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAT = {
  'Steel (general)': { E: 210000, nu: 0.30 },
  'Steel 100Cr6': { E: 210000, nu: 0.30 },
  'Cast Iron': { E: 150000, nu: 0.25 },
  'Aluminum': { E: 70000, nu: 0.33 },
  'Brass': { E: 100000, nu: 0.34 },
  'Bronze': { E: 110000, nu: 0.34 },
  'Titanium': { E: 114000, nu: 0.34 },
  'Copper': { E: 120000, nu: 0.34 },
  'PTFE': { E: 500, nu: 0.46 },
};

const THREAD_DATA = {
  'M3':  {d:3,   P:0.5,  d2:2.675, d3:2.387, As:5.03},
  'M4':  {d:4,   P:0.7,  d2:3.545, d3:3.141, As:8.78},
  'M5':  {d:5,   P:0.8,  d2:4.480, d3:3.975, As:14.2},
  'M6':  {d:6,   P:1.0,  d2:5.350, d3:4.773, As:20.1},
  'M8':  {d:8,   P:1.25, d2:7.188, d3:6.466, As:36.6},
  'M10': {d:10,  P:1.5,  d2:9.026, d3:8.160, As:58.0},
  'M12': {d:12,  P:1.75, d2:10.863,d3:9.853, As:84.3},
  'M14': {d:14,  P:2.0,  d2:12.701,d3:11.546,As:115},
  'M16': {d:16,  P:2.0,  d2:14.701,d3:13.546,As:157},
  'M18': {d:18,  P:2.5,  d2:16.376,d3:15.294,As:192},
  'M20': {d:20,  P:2.5,  d2:18.376,d3:17.294,As:245},
  'M22': {d:22,  P:2.5,  d2:20.376,d3:19.294,As:303},
  'M24': {d:24,  P:3.0,  d2:22.051,d3:21.052,As:353},
  'M27': {d:27,  P:3.0,  d2:25.051,d3:24.052,As:459},
  'M30': {d:30,  P:3.5,  d2:27.727,d3:26.211,As:561},
};

const BOLT_CLASS = {
  '4.6':  {Su:400, Sp:240},
  '5.6':  {Su:500, Sp:300},
  '8.8':  {Su:800, Sp:640},
  '10.9': {Su:1000,Sp:900},
  '12.9': {Su:1200,Sp:1080},
};

const RELIABILITY = {50:1.000, 90:0.897, 95:0.868, 99:0.814, 99.9:0.753, 99.99:0.702};

const SURFACE_FINISH = {
  'Ground':     {a:1.58, b:-0.085},
  'Machined':   {a:4.51, b:-0.265},
  'Hot-rolled': {a:57.7, b:-0.718},
  'As-forged':  {a:272,  b:-0.995},
};

const PIPE_ROUGHNESS = {
  'Steel (new)': 0.045,
  'Steel (corroded)': 0.3,
  'Cast iron': 0.26,
  'Copper/Brass': 0.0015,
  'PVC/Plastic': 0.0015,
  'Concrete': 1.0,
  'Galvanized': 0.15,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEAT TRANSFER: FLUID PROPERTY DATABASE (VDI Heat Atlas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FLUID_DB = {
  water: {
    name: 'Water (liquid, saturation)',
    T:      [0,10,20,30,40,50,60,70,80,90,100,110,120,140,160,180,200],
    rho:    [999.8,999.7,998.2,995.6,992.2,988.1,983.2,977.8,971.8,965.3,958.4,951.0,943.1,926.1,907.4,887.0,864.7],
    cp:     [4217,4193,4182,4178,4179,4181,4185,4190,4197,4205,4216,4229,4244,4283,4339,4410,4497],
    lambda: [0.561,0.580,0.598,0.615,0.631,0.643,0.654,0.663,0.670,0.675,0.679,0.682,0.683,0.683,0.680,0.673,0.663],
    mu:     [1.792e-3,1.307e-3,1.002e-3,0.798e-3,0.653e-3,0.547e-3,0.467e-3,0.404e-3,0.355e-3,0.315e-3,0.282e-3,0.255e-3,0.232e-3,0.196e-3,0.170e-3,0.150e-3,0.134e-3],
    Pr:     [13.44,9.45,7.01,5.42,4.33,3.56,2.99,2.55,2.22,1.96,1.75,1.58,1.44,1.23,1.09,0.98,0.91],
    beta:   [-0.68e-4,0.88e-4,2.07e-4,3.03e-4,3.85e-4,4.49e-4,5.23e-4,5.84e-4,6.32e-4,6.95e-4,7.52e-4,8.05e-4,8.55e-4,9.66e-4,10.9e-4,12.3e-4,14.1e-4]
  },
  air: {
    name: 'Dry air (1 bar)',
    T:      [-50,-20,0,20,40,60,80,100,150,200,250,300,400,500],
    rho:    [1.584,1.395,1.293,1.205,1.127,1.059,0.999,0.946,0.834,0.746,0.674,0.616,0.524,0.456],
    cp:     [1006,1006,1006,1007,1007,1008,1010,1012,1017,1023,1033,1040,1059,1078],
    lambda: [0.0204,0.0228,0.0243,0.0257,0.0271,0.0285,0.0299,0.0314,0.0349,0.0383,0.0417,0.0448,0.0509,0.0566],
    mu:     [1.474e-5,1.622e-5,1.716e-5,1.813e-5,1.907e-5,1.999e-5,2.087e-5,2.172e-5,2.380e-5,2.577e-5,2.760e-5,2.947e-5,3.291e-5,3.613e-5],
    Pr:     [0.728,0.715,0.711,0.711,0.709,0.708,0.706,0.699,0.692,0.688,0.684,0.684,0.685,0.688],
    beta:   null
  }
};

function lerp(x, xArr, yArr) {
  if (x <= xArr[0]) return yArr[0];
  if (x >= xArr[xArr.length-1]) return yArr[yArr.length-1];
  for (let i = 0; i < xArr.length-1; i++) {
    if (x >= xArr[i] && x <= xArr[i+1]) {
      const t = (x - xArr[i]) / (xArr[i+1] - xArr[i]);
      return yArr[i] + t * (yArr[i+1] - yArr[i]);
    }
  }
  return yArr[yArr.length-1];
}

function getFluidProps(fluid, T) {
  const db = FLUID_DB[fluid];
  if (!db) return null;
  const props = {
    rho: lerp(T, db.T, db.rho), cp: lerp(T, db.T, db.cp),
    lambda: lerp(T, db.T, db.lambda), mu: lerp(T, db.T, db.mu),
    Pr: lerp(T, db.T, db.Pr),
    beta: db.beta ? lerp(T, db.T, db.beta) : 1/(T+273.15), nu: null
  };
  props.nu = props.mu / props.rho;
  return props;
}

function htFmt(val, digits) {
  if (val === undefined || val === null || isNaN(val)) return 'â€”';
  if (Math.abs(val) >= 1e5 || (Math.abs(val) < 0.01 && val !== 0)) return val.toExponential(digits||3);
  return val.toFixed(digits !== undefined ? digits : 2);
}
function htFmtSci(val, digits) {
  if (val === undefined || val === null || isNaN(val)) return 'â€”';
  return val.toExponential(digits||3);
}
function htResultHTML(items) {
  return items.map(it => {
    const cls = it.highlight ? 'ht-result-item highlight' : 'ht-result-item';
    const full = it.full ? ' full' : '';
    return '<div class="'+cls+full+'"><span class="lbl">'+it.label+'</span><span class="val">'+it.value+'<span class="unit">'+(it.unit||'')+'</span></span></div>';
  }).join('');
}
function htClearResults(prefix) {
  const el = document.getElementById(prefix+'-results');
  if (el) el.classList.remove('show');
}
function htUpdateFluidProps(prefix) {
  const fluid = document.getElementById(prefix+'-fluid').value;
  const customDiv = document.getElementById(prefix+'-custom-props');
  const propsDiv = document.getElementById(prefix+'-props-display');
  if (fluid === 'custom') { customDiv.style.display = 'block'; propsDiv.innerHTML = ''; return; }
  customDiv.style.display = 'none';
  let T;
  if (prefix === 'fc') T = parseFloat(document.getElementById('fc-Tb').value);
  else if (prefix === 'nc') T = parseFloat(document.getElementById('nc-Tf').value);
  if (isNaN(T)) return;
  const p = getFluidProps(fluid, T);
  if (!p) return;
  propsDiv.innerHTML = [
    {k:'&rho;',v:htFmt(p.rho,1),u:'kg/m&sup3;'},{k:'c<sub>p</sub>',v:htFmt(p.cp,0),u:'J/(kg&middot;K)'},
    {k:'&lambda;',v:htFmt(p.lambda,4),u:'W/(m&middot;K)'},{k:'&mu;',v:htFmtSci(p.mu,3),u:'Pa&middot;s'},
    {k:'Pr',v:htFmt(p.Pr,3),u:''},{k:'&beta;',v:htFmtSci(p.beta,3),u:'1/K'},
    {k:'&nu;',v:htFmtSci(p.nu,3),u:'m&sup2;/s'}
  ].map(i=>'<div class="ht-prop-chip"><span class="pk">'+i.k+'</span><span class="pv">'+i.v+' '+i.u+'</span></div>').join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATOR DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CALCS = [
  // â”€â”€ CONTACT MECHANICS â”€â”€
  {id:'e2_1', name:'Hertzian Point Contact', cat:'Contact Mechanics', color:'var(--cat-contact)', icon:'âš™ï¸',
   desc:'Contact pressure and deformation for two curved bodies in point contact (ball-on-flat, ball-on-ball). Matches werktuigbouw.nl/e2_1.',
   inputs:[
     {id:'E1',label:"Young's modulus Eâ‚",unit:'GPa',val:213},
     {id:'E2',label:"Young's modulus Eâ‚‚",unit:'GPa',val:213},
     {id:'nu1',label:'Poisson\'s ratio Î½â‚',unit:'â€”',val:0.29},
     {id:'nu2',label:'Poisson\'s ratio Î½â‚‚',unit:'â€”',val:0.29},
     {id:'R1',label:'Radius Râ‚ (0 = flat)',unit:'mm',val:5},
     {id:'R2',label:'Radius Râ‚‚ (0 = flat)',unit:'mm',val:0},
     {id:'F',label:'Normal force F',unit:'N',val:100},
   ],
   outputs:["Ep|Effective Young's modulus E'|GPa","Rp|Effective contact radius R'|mm",'r|Semi contact width r|mm','delta|Indentation Î´|Âµm','k|Contact stiffness|10â¶ N/m','pm|Mean contact pressure p_m|GPa','pmax|Max contact pressure p_max|GPa'],
   calc(v){
     const Ep = 2/((1-v.nu1**2)/v.E1 + (1-v.nu2**2)/v.E2);
     let inv_Rp = 0;
     if(v.R1 > 0) inv_Rp += 2/v.R1;
     if(v.R2 > 0) inv_Rp += 2/v.R2;
     if(inv_Rp === 0) return {'Ep':'â€”','Rp':'â€”','r':'â€”','delta':'â€”','k':'â€”','pm':'â€”','pmax':'â€”'};
     const Rp = 1/inv_Rp;
     const Ep_Pa = Ep*1e9, Rp_m = Rp*1e-3, Estar = Ep_Pa/2, Req = 2*Rp_m;
     const a = Math.pow(3*v.F*Req/(4*Estar),1/3);
     const delta = Math.pow(9*v.F*v.F/(16*Req*Estar*Estar),1/3);
     const k = 1.5*v.F/delta;
     const Ac = Math.PI*a*a;
     const pm = v.F/Ac;
     const pmax = 1.5*pm;
     return {'Ep':Ep.toFixed(1),'Rp':Rp.toFixed(2),'r':(a*1e3).toFixed(2),'delta':(delta*1e6).toFixed(2),'k':(k/1e6).toFixed(2),'pm':(pm/1e9).toFixed(2),'pmax':(pmax/1e9).toFixed(2)};
   },
   formula:"2/E' = (1âˆ’Î½â‚Â²)/Eâ‚ + (1âˆ’Î½â‚‚Â²)/Eâ‚‚\n1/R' = Î£(1/R_ij) principal curvatures\na = âˆ›(3FR_eq / 4E*) where R_eq=2R', E*=E'/2\nÎ´ = âˆ›(9FÂ² / 16R_eqÂ·E*Â²)\nk = 3F/(2Î´)\np_m = F/(Ï€aÂ²)\np_max = 1.5Â·p_m"
  },

  {id:'e2_3', name:'Hertzian Line Contact', cat:'Contact Mechanics', color:'var(--cat-contact)', icon:'âš™ï¸',
   desc:'Contact half-width and pressure for two parallel cylinders in line contact. Matches werktuigbouw.nl/e2_3.',
   inputs:[
     {id:'E1',label:"Young's modulus Eâ‚",unit:'GPa',val:213},
     {id:'E2',label:"Young's modulus Eâ‚‚",unit:'GPa',val:213},
     {id:'nu1',label:'Poisson\'s ratio Î½â‚',unit:'â€”',val:0.29},
     {id:'nu2',label:'Poisson\'s ratio Î½â‚‚',unit:'â€”',val:0.29},
     {id:'R1',label:'Radius Râ‚ (0 = flat)',unit:'mm',val:15},
     {id:'R2',label:'Radius Râ‚‚ (0 = flat)',unit:'mm',val:0},
     {id:'FL',label:'Contact load F/L',unit:'kN/m',val:1000},
   ],
   outputs:["Ep|Effective Young's modulus E'|GPa","Rp|Effective contact radius R'|mm",'b|Semi contact width b|mm','pm|Mean contact pressure p_m|GPa','pmax|Max contact pressure p_max|GPa'],
   calc(v){
     const Ep = 2/((1-v.nu1**2)/v.E1 + (1-v.nu2**2)/v.E2);
     let inv_Rp = 0;
     if(v.R1 > 0) inv_Rp += 1/v.R1;
     if(v.R2 > 0) inv_Rp += 1/v.R2;
     if(inv_Rp === 0) return {'Ep':'â€”','Rp':'â€”','b':'â€”','pm':'â€”','pmax':'â€”'};
     const Rp = 1/inv_Rp;
     const Ep_Pa = Ep*1e9, Rp_m = Rp*1e-3, Estar = Ep_Pa/2, FL = v.FL*1e3;
     const b = Math.sqrt(4*FL*Rp_m/(Math.PI*Estar));
     const pm = FL/(2*b);
     const pmax = 2*FL/(Math.PI*b);
     return {'Ep':Ep.toFixed(1),'Rp':Rp.toFixed(2),'b':(b*1e3).toFixed(2),'pm':(pm/1e9).toFixed(2),'pmax':(pmax/1e9).toFixed(2)};
   },
   formula:"2/E' = (1âˆ’Î½â‚Â²)/Eâ‚ + (1âˆ’Î½â‚‚Â²)/Eâ‚‚\n1/R' = 1/Râ‚ + 1/Râ‚‚ (one principal direction)\nb = âˆš(4Â·F'Â·R' / Ï€Â·E*) where E*=E'/2\np_m = F'/(2b)\np_max = 2F'/(Ï€b) = (4/Ï€)Â·p_m"
  },

  {id:'e2_6b', name:'Gear Contact Stress (AGMA)', cat:'Contact Mechanics', color:'var(--cat-contact)', icon:'âš™ï¸',
   desc:'Hertzian contact stress on gear teeth per AGMA standard.',
   inputs:[
     {id:'Wt',label:'Tangential load',unit:'N',val:2000},
     {id:'dp',label:'Pitch diameter (pinion)',unit:'mm',val:80},
     {id:'Fw',label:'Face width',unit:'mm',val:40},
     {id:'E1',label:'E pinion',unit:'MPa',val:210000},
     {id:'E2',label:'E gear',unit:'MPa',val:210000},
     {id:'nu1',label:'Î½ pinion',unit:'â€”',val:0.30},
     {id:'nu2',label:'Î½ gear',unit:'â€”',val:0.30},
     {id:'Ko',label:'Overload factor Ko',unit:'â€”',val:1.0},
     {id:'Kv',label:'Dynamic factor Kv',unit:'â€”',val:1.2},
     {id:'Km',label:'Load distribution Km',unit:'â€”',val:1.3},
     {id:'I',label:'Geometry factor I',unit:'â€”',val:0.11},
   ],
   outputs:['Cp|Elastic coefficient|âˆšMPa','sc|Contact stress|MPa'],
   calc(v){
     const Cp = Math.sqrt(1/(Math.PI*((1-v.nu1**2)/v.E1+(1-v.nu2**2)/v.E2)));
     const sc = Cp*Math.sqrt((v.Wt*v.Ko*v.Kv*v.Km)/(v.dp*v.Fw*v.I));
     return {'Cp':Cp.toFixed(1),'sc':sc.toFixed(0)};
   },
   formula:'Cp = âˆš(1 / Ï€[(1âˆ’Î½â‚Â²)/Eâ‚ + (1âˆ’Î½â‚‚Â²)/Eâ‚‚])\nÏƒc = Cp Â· âˆš(WtÂ·KoÂ·KvÂ·Km / dÂ·FÂ·I)'
  },

  // â”€â”€ ROLLING BEARINGS â”€â”€
  {id:'L10', name:'Bearing Life (L10)', cat:'Rolling Bearings', color:'var(--cat-bearing-roll)', icon:'ğŸ”„',
   desc:'Basic rating life per ISO 281. Matches werktuigbouw.nl/L10. Default: bearing 16004.',
   inputs:[
     {id:'C',label:'Dynamic load rating C',unit:'kN',val:7.28},
     {id:'P',label:'Equivalent bearing load P',unit:'kN',val:1},
     {id:'n',label:'Rotational speed',unit:'rpm',val:2800},
     {id:'p',label:'Life exponent p',unit:'â€”',val:3, hint:'3 = ball, 10/3 = roller'},
   ],
   outputs:['L10|Basic rating life|Ã—10â¶ rev','L10h|Rating life|hours','L10y|Rating life|years (8000h/yr)'],
   calc(v){
     const L10 = Math.pow(v.C/v.P, v.p);
     const L10h = L10*1e6/(60*v.n);
     return {'L10':L10.toFixed(0),'L10h':L10h.toFixed(0),'L10y':(L10h/8000).toFixed(1)};
   },
   formula:'Lâ‚â‚€ = (C/P)^p  [Ã—10â¶ rev]\nLâ‚â‚€h = Lâ‚â‚€ Â· 10â¶ / (60Â·n)  [hours]'
  },

  {id:'pe', name:'Equivalent Bearing Load', cat:'Rolling Bearings', color:'var(--cat-bearing-roll)', icon:'ğŸ”„',
   desc:'Equivalent static & dynamic bearing load for deep groove ball bearings.',
   inputs:[
     {id:'Fr',label:'Radial force Fr',unit:'N',val:3000},
     {id:'Fa',label:'Axial force Fa',unit:'N',val:1000},
     {id:'X',label:'Radial factor X',unit:'â€”',val:0.56},
     {id:'Y',label:'Axial factor Y',unit:'â€”',val:1.0},
   ],
   outputs:['P|Dynamic equivalent load|N','P0|Static equivalent load|N'],
   calc(v){
     const P = v.X*v.Fr + v.Y*v.Fa;
     let P0 = 0.6*v.Fr + 0.5*v.Fa;
     if(P0 < v.Fr) P0 = v.Fr;
     return {'P':Math.max(P,v.Fr).toFixed(0),'P0':P0.toFixed(0)};
   },
   formula:'P = XÂ·Fr + YÂ·Fa  (if P < Fr â†’ P = Fr)\nPâ‚€ = max(0.6Â·Fr + 0.5Â·Fa, Fr)'
  },

  // â”€â”€ SHAFT-HUB CONNECTIONS â”€â”€
  {id:'e3_8', name:'Interference Fits', cat:'Shaft-Hub Connections', color:'var(--cat-shaft)', icon:'ğŸ”§',
   desc:'Press/shrink/expansion fit calculator. Contact pressure, stresses, assembly force and torque capacity.',
   inputs:[
     {id:'di',label:'Shaft bore dáµ¢ (0 = solid)',unit:'mm',val:20},
     {id:'d',label:'Interface diameter d',unit:'mm',val:23},
     {id:'do_hub',label:'Hub outer diameter dâ‚’',unit:'mm',val:80},
     {id:'Lc',label:'Contact length L',unit:'mm',val:20},
     {id:'delta',label:'Diametral interference Î´',unit:'mm',val:0.023},
     {id:'E1',label:'E shaft (inner)',unit:'GPa',val:100, hint:'Bronze â‰ˆ 100, Steel â‰ˆ 210'},
     {id:'E2',label:'E hub (outer)',unit:'GPa',val:210},
     {id:'nu1',label:'Î½ shaft',unit:'â€”',val:0.30},
     {id:'nu2',label:'Î½ hub',unit:'â€”',val:0.30},
     {id:'mu',label:'Friction coefficient Âµ',unit:'â€”',val:0.12},
   ],
   outputs:['p|Contact pressure|MPa','st_hub|Tangential stress hub|MPa','st_shaft|Tangential stress shaft|MPa','F_assy|Assembly/removal force|kN','T_cap|Torque capacity|NÂ·m'],
   calc(v){
     const d=v.d, D=v.do_hub, di=v.di;
     const E1=v.E1*1000, E2=v.E2*1000; // GPaâ†’MPa
     const C1 = di===0 ? (1 - v.nu1) : ((d*d+di*di)/(d*d-di*di) - v.nu1);
     const C2 = (D*D+d*d)/(D*D-d*d) + v.nu2;
     const p = v.delta/(d*(C1/E1+C2/E2));
     const st_hub = p*(D*D+d*d)/(D*D-d*d);
     const st_shaft = di===0 ? -p : -p*(d*d+di*di)/(d*d-di*di);
     const F = v.mu*p*Math.PI*d*v.Lc/1000;
     const T = v.mu*p*Math.PI*d*v.Lc*(d/2)/1000;
     return {'p':p.toFixed(2),'st_hub':st_hub.toFixed(2),'st_shaft':st_shaft.toFixed(2),'F_assy':F.toFixed(2),'T_cap':T.toFixed(2)};
   },
   formula:'Câ‚ = (dÂ²+dáµ¢Â²)/(dÂ²âˆ’dáµ¢Â²) âˆ’ Î½â‚\nCâ‚‚ = (DÂ²+dÂ²)/(DÂ²âˆ’dÂ²) + Î½â‚‚\np = Î´ / [dÂ·(Câ‚/Eâ‚ + Câ‚‚/Eâ‚‚)]\nÏƒt,hub = pÂ·(DÂ²+dÂ²)/(DÂ²âˆ’dÂ²)\nF = ÂµÂ·pÂ·Ï€Â·dÂ·L\nT = ÂµÂ·pÂ·Ï€Â·dÂ·LÂ·d/2'
  },

  {id:'key', name:'Shaft Key Design', cat:'Shaft-Hub Connections', color:'var(--cat-shaft)', icon:'ğŸ”§',
   desc:'Bearing pressure and shear stress in parallel key connections.',
   inputs:[
     {id:'T',label:'Torque',unit:'NÂ·m',val:200},
     {id:'d',label:'Shaft diameter',unit:'mm',val:30},
     {id:'b',label:'Key width',unit:'mm',val:8},
     {id:'h',label:'Key height',unit:'mm',val:7},
     {id:'l',label:'Key length',unit:'mm',val:30},
     {id:'Sy',label:'Yield strength (weakest part)',unit:'MPa',val:350},
   ],
   outputs:['sigma|Bearing pressure|MPa','tau|Shear stress in key|MPa','SF_bearing|Safety factor (bearing)|â€”','SF_shear|Safety factor (shear)|â€”'],
   calc(v){
     const Tnmm = v.T*1000;
     const sigma = 2*Tnmm/(v.d*(v.h/2)*v.l);
     const tau = 2*Tnmm/(v.d*v.b*v.l);
     return {'sigma':sigma.toFixed(1),'tau':tau.toFixed(1),'SF_bearing':(v.Sy/sigma).toFixed(2),'SF_shear':(v.Sy*0.577/tau).toFixed(2)};
   },
   formula:'Ïƒ = 2T / (d Â· h/2 Â· l)  [bearing pressure]\nÏ„ = 2T / (d Â· b Â· l)  [shear stress]\nSF = Ïƒ_yield / Ïƒ_actual'
  },

  {id:'c5_16', name:'Self-Locking Cone Fit', cat:'Shaft-Hub Connections', color:'var(--cat-shaft)', icon:'ğŸ”§',
   desc:'Self-locking condition and torque capacity for taper cone shaft-hub connections.',
   inputs:[
     {id:'alpha',label:'Full taper angle Î±',unit:'Â°',val:6},
     {id:'mu',label:'Friction coefficient Âµ',unit:'â€”',val:0.15},
     {id:'d',label:'Mean contact diameter',unit:'mm',val:50},
     {id:'L',label:'Contact length',unit:'mm',val:60},
     {id:'p',label:'Contact pressure',unit:'MPa',val:80},
   ],
   outputs:['locking|Self-locking?|','SF_lock|Self-lock safety factor|â€”','T_cap|Torque capacity|NÂ·m','F_axial|Axial assembly force|kN'],
   calc(v){
     const a_rad = v.alpha*Math.PI/360; // half-angle
     const tanA = Math.tan(a_rad);
     const locking = v.mu >= tanA;
     const SF = v.mu/tanA;
     const T = v.mu*v.p*Math.PI*(v.d/1000)*(v.L/1000)*(v.d/2000)*1e6;
     const Fa = v.p*Math.PI*(v.d/1000)*(v.L/1000)*(Math.sin(a_rad)+v.mu*Math.cos(a_rad))/1000;
     return {'locking':locking?'YES â€” self-locking':'NO â€” will slip','SF_lock':SF.toFixed(2),'T_cap':T.toFixed(1),'F_axial':Fa.toFixed(2)};
   },
   formula:'Self-locking when Âµ â‰¥ tan(Î±/2)\nT = ÂµÂ·pÂ·Ï€Â·dÂ·LÂ·d/2\nFa = pÂ·Ï€Â·dÂ·LÂ·(sin Î±/2 + ÂµÂ·cos Î±/2)'
  },

  // â”€â”€ FASTENERS & BOLTS â”€â”€
  {id:'e3_6a', name:'Bolt Tightening Torque (VDI 2230)', cat:'Fasteners & Bolts', color:'var(--cat-fastener)', icon:'ğŸ”©',
   desc:'Tightening torque to preload a bolt with thread and head friction per VDI 2230. Matches werktuigbouw.nl/e3_6a.',
   inputs:[
     {id:'size',label:'Thread size',unit:'',val:'M12',type:'select',options:Object.keys(THREAD_DATA)},
     {id:'cls',label:'Property class',unit:'',val:'8.8',type:'select',options:Object.keys(BOLT_CLASS)},
     {id:'sigma_util',label:'Tensile stress Ïƒt',unit:'Ã—Rp0.2',val:0.6, hint:'Fraction of yield for target preload'},
     {id:'mu_th',label:'Thread friction Âµ_th',unit:'â€”',val:0.15},
     {id:'mu_hd',label:'Head friction Âµ_hd',unit:'â€”',val:0.15},
   ],
   outputs:['At|Stress area|mmÂ²','Rp|Yield strength|MPa','sigma_t|Tensile stress Ïƒt|MPa','tau|Torsional stress Ï„|MPa','sigma_e|Equivalent stress Ïƒe|MPa','MG|Thread friction torque|NÂ·m','MWD|Head friction torque|NÂ·m','MA|Total tightening torque|NÂ·m','Fi|Initial preload|kN','F02|Load at yield|kN','Pb|Load reserve|kN'],
   calc(v){
     const t = THREAD_DATA[v.size];
     const bc = BOLT_CLASS[v.cls];
     const Rp = bc.Sp; const At = t.As;
     const sigma_t = v.sigma_util * Rp;
     const Fi = sigma_t * At / 1000;
     const P = t.P; const d2 = t.d2; const d3 = t.d3; const d_nom = t.d;
     const alpha_rad = Math.atan(P/(Math.PI*d2));
     const rho_rad = Math.atan(v.mu_th/Math.cos(Math.PI/6));
     const MG = Fi*1000*(d2/2)*Math.tan(alpha_rad+rho_rad)/1000;
     const dw = 1.3*d_nom;
     const MWD = Fi*1000*v.mu_hd*(dw/2)/1000;
     const MA = MG + MWD;
     const Wp = Math.PI*d3*d3*d3/16;
     const tau = MG*1000/Wp;
     const sigma_e = Math.sqrt(sigma_t*sigma_t + 3*tau*tau);
     const F02 = Rp*At/1000;
     const Pb = F02 - Fi;
     return {'At':At.toFixed(2),'Rp':Rp.toFixed(0),'sigma_t':sigma_t.toFixed(2),'tau':tau.toFixed(2),'sigma_e':sigma_e.toFixed(2),'MG':MG.toFixed(2),'MWD':MWD.toFixed(2),'MA':MA.toFixed(2),'Fi':Fi.toFixed(2),'F02':F02.toFixed(2),'Pb':Pb.toFixed(2)};
   },
   formula:'Ïƒt = utilization Ã— Rp0.2\nFi = Ïƒt Â· At\nMG = FiÂ·(dâ‚‚/2)Â·tan(Î±+Ïâ€²)\nÎ± = atan(P/Ï€dâ‚‚), Ïâ€² = atan(Âµth/cos30Â°)\nMWD = FiÂ·ÂµhdÂ·dw/2 (dwâ‰ˆ1.3d)\nMA = MG + MWD\nÏ„ = MG / Wp, Wp=Ï€dâ‚ƒÂ³/16\nÏƒe = âˆš(ÏƒtÂ²+3Ï„Â²)'
  },

  {id:'e3_6b', name:'Max Tightening Torque (VDI 2230)', cat:'Fasteners & Bolts', color:'var(--cat-fastener)', icon:'ğŸ”©',
   desc:'Maximum tightening torque at bolt yield (Ïƒe = Rp0.2). Matches werktuigbouw.nl/e3_6b.',
   inputs:[
     {id:'size',label:'Thread size',unit:'',val:'M12',type:'select',options:Object.keys(THREAD_DATA)},
     {id:'cls',label:'Property class',unit:'',val:'8.8',type:'select',options:Object.keys(BOLT_CLASS)},
     {id:'sigma_util',label:'Max equiv. stress Ïƒe',unit:'Ã—Rp0.2',val:0.9, hint:'Fraction of yield for Ïƒe limit'},
     {id:'mu_th',label:'Thread friction Âµ_th',unit:'â€”',val:0.15},
     {id:'mu_hd',label:'Head friction Âµ_hd',unit:'â€”',val:0.15},
   ],
   outputs:['At|Stress area|mmÂ²','Rp|Yield strength|MPa','sigma_e|Equiv. stress Ïƒe|MPa','tau|Torsional stress Ï„|MPa','sigma_t|Tensile stress Ïƒt|MPa','MG|Thread friction torque|NÂ·m','MWD|Head friction torque|NÂ·m','MA|Total tightening torque|NÂ·m','Fi|Initial preload|kN','relax|Stress relaxation|%','Pb|Load reserve|kN'],
   calc(v){
     const t = THREAD_DATA[v.size];
     const bc = BOLT_CLASS[v.cls];
     const Rp = bc.Sp; const At = t.As;
     const sigma_e_target = v.sigma_util * Rp;
     const P = t.P; const d2 = t.d2; const d3 = t.d3; const d_nom = t.d;
     const alpha_rad = Math.atan(P/(Math.PI*d2));
     const rho_rad = Math.atan(v.mu_th/Math.cos(Math.PI/6));
     const Wp = Math.PI*d3*d3*d3/16;
     const k = (d2/2)*Math.tan(alpha_rad+rho_rad)/(Wp/At);
     const sigma_t = sigma_e_target/Math.sqrt(1+3*k*k);
     const Fi = sigma_t*At/1000;
     const tau = k*sigma_t;
     const MG = Fi*1000*(d2/2)*Math.tan(alpha_rad+rho_rad)/1000;
     const dw = 1.3*d_nom;
     const MWD = Fi*1000*v.mu_hd*(dw/2)/1000;
     const MA = MG + MWD;
     const sigma_e_check = Math.sqrt(sigma_t*sigma_t+3*tau*tau);
     const relax = (sigma_e_check-sigma_t)/sigma_e_check*100;
     const F02 = Rp*At/1000;
     const Pb = F02-Fi;
     return {'At':At.toFixed(2),'Rp':Rp.toFixed(0),'sigma_e':sigma_e_check.toFixed(2),'tau':tau.toFixed(2),'sigma_t':sigma_t.toFixed(2),'MG':MG.toFixed(2),'MWD':MWD.toFixed(2),'MA':MA.toFixed(2),'Fi':Fi.toFixed(2),'relax':relax.toFixed(2),'Pb':Pb.toFixed(2)};
   },
   formula:'Ïƒe = util Ã— Rp0.2\nÏƒt = Ïƒe / âˆš(1 + 3kÂ²)\nk = (dâ‚‚/2)Â·tan(Î±+Ïâ€²) / (Wp/At)\nFi = ÏƒtÂ·At\nMG, MWD, MA as per e3_6a\nRelaxation = (Ïƒeâˆ’Ïƒt)/Ïƒe Ã— 100%'
  },

  {id:'e3_6e', name:'Thread Stripping Strength', cat:'Fasteners & Bolts', color:'var(--cat-fastener)', icon:'ğŸ”©',
   desc:'Thread stripping force for external and internal threads.',
   inputs:[
     {id:'size',label:'Thread size',unit:'',val:'M10',type:'select',options:Object.keys(THREAD_DATA)},
     {id:'Le',label:'Engagement length',unit:'mm',val:15},
     {id:'tau_bolt',label:'Shear strength bolt',unit:'MPa',val:460, hint:'â‰ˆ 0.577 Ã— Su'},
     {id:'tau_nut',label:'Shear strength nut',unit:'MPa',val:460},
   ],
   outputs:['ASs|Ext. thread shear area|mmÂ²','ASn|Int. thread shear area|mmÂ²','Fss|Ext. stripping force|kN','Fsn|Int. stripping force|kN'],
   calc(v){
     const t = THREAD_DATA[v.size];
     const ASs = 0.5*Math.PI*t.d2*v.Le;
     const ASn = 0.5*Math.PI*t.d*v.Le;
     return {'ASs':ASs.toFixed(1),'ASn':ASn.toFixed(1),'Fss':(ASs*v.tau_bolt/1000).toFixed(1),'Fsn':(ASn*v.tau_nut/1000).toFixed(1)};
   },
   formula:'ASs â‰ˆ 0.5Â·Ï€Â·dâ‚‚Â·Le (ext. thread)\nASn â‰ˆ 0.5Â·Ï€Â·dÂ·Le (int. thread)\nF_strip = AS Â· Ï„_shear'
  },

  {id:'unf_1', name:'Max Tensile Load (Bolt)', cat:'Fasteners & Bolts', color:'var(--cat-fastener)', icon:'ğŸ”©',
   desc:'Maximum tensile load of a bolt based on property class.',
   inputs:[
     {id:'size',label:'Thread size',unit:'',val:'M10',type:'select',options:Object.keys(THREAD_DATA)},
     {id:'cls',label:'Property class',unit:'',val:'8.8',type:'select',options:Object.keys(BOLT_CLASS)},
   ],
   outputs:['As|Stress area|mmÂ²','Fp|Proof load|kN','Fu|Ultimate load|kN'],
   calc(v){
     const t = THREAD_DATA[v.size];
     const bc = BOLT_CLASS[v.cls];
     return {'As':t.As.toFixed(1),'Fp':(bc.Sp*t.As/1000).toFixed(1),'Fu':(bc.Su*t.As/1000).toFixed(1)};
   },
   formula:'Fp = Sp Â· As\nFu = Su Â· As'
  },

  {id:'metric_iso', name:'Metric ISO Thread Table', cat:'Fasteners & Bolts', color:'var(--cat-fastener)', icon:'ğŸ”©',
   desc:'Reference table for metric ISO thread dimensions per ISO 724 / DIN 13.',
   inputs:[],
   outputs:[],
   calc(){ return {}; },
   customRender(){
     let h = '<table class="ref-table"><tr><th>Size</th><th>Pitch P (mm)</th><th>Pitch âŒ€ dâ‚‚ (mm)</th><th>Minor âŒ€ dâ‚ƒ (mm)</th><th>Stress area As (mmÂ²)</th></tr>';
     for(const[k,v] of Object.entries(THREAD_DATA)){
       h+=`<tr><td><b>${k}</b></td><td>${v.P}</td><td>${v.d2}</td><td>${v.d3}</td><td>${v.As}</td></tr>`;
     }
     h+='</table>';
     return h;
   },
   formula:'dâ‚‚ = d âˆ’ 0.6495Â·P\ndâ‚ƒ = d âˆ’ 1.2269Â·P\nAs = Ï€/4 Â· [(dâ‚‚+dâ‚ƒ)/2]Â²'
  },

  // â”€â”€ FATIGUE STRENGTH â”€â”€
  {id:'f_2', name:'Drive Shaft Fatigue (Bending)', cat:'Fatigue Strength', color:'var(--cat-fatigue)', icon:'ğŸ“‰',
   desc:'Modified endurance limit for a rotating shaft in bending using Marin correction factors.',
   inputs:[
     {id:'Sut',label:'Ultimate tensile strength',unit:'MPa',val:600},
     {id:'d',label:'Shaft diameter',unit:'mm',val:30},
     {id:'finish',label:'Surface finish',unit:'',val:'Machined',type:'select',options:Object.keys(SURFACE_FINISH)},
     {id:'rel',label:'Reliability',unit:'%',val:'99',type:'select',options:Object.keys(RELIABILITY)},
     {id:'Kt',label:'Stress concentration Kt',unit:'â€”',val:1.5},
     {id:'q',label:'Notch sensitivity q',unit:'â€”',val:0.85, hint:'0 to 1'},
   ],
   outputs:['Se_prime|Base endurance limit|MPa','ka|Surface factor ka|â€”','kb|Size factor kb|â€”','Cr|Reliability factor Cr|â€”','Kf|Fatigue notch factor Kf|â€”','Se|Modified endurance limit|MPa'],
   calc(v){
     const Se_prime = 0.5*v.Sut;
     const sf = SURFACE_FINISH[v.finish];
     const ka = sf.a*Math.pow(v.Sut,sf.b);
     let kb = 1.0;
     if(v.d>=2.79&&v.d<=51) kb=1.24*Math.pow(v.d,-0.107);
     else if(v.d>51&&v.d<=254) kb=1.51*Math.pow(v.d,-0.157);
     const Cr = RELIABILITY[v.rel]||1.0;
     const Kf = 1+(v.Kt-1)*v.q;
     const Se = ka*kb*Cr*Se_prime/Kf;
     return {'Se_prime':Se_prime.toFixed(0),'ka':ka.toFixed(3),'kb':kb.toFixed(3),'Cr':Cr.toFixed(3),'Kf':Kf.toFixed(3),'Se':Se.toFixed(0)};
   },
   formula:"Se' = 0.5Â·Sut\nka = aÂ·Sut^b (surface)\nkb = 1.24Â·d^(âˆ’0.107) (size, dâ‰¤51mm)\nKf = 1+(Ktâˆ’1)Â·q\nSe = kaÂ·kbÂ·CrÂ·Se'/Kf"
  },

  {id:'p1_6', name:'Reliability Factor Table', cat:'Fatigue Strength', color:'var(--cat-fatigue)', icon:'ğŸ“‰',
   desc:'Reliability correction factor Cr for fatigue strength calculations.',
   inputs:[],
   outputs:[],
   calc(){ return {}; },
   customRender(){
     let h = '<table class="ref-table"><tr><th>Reliability (%)</th><th>Factor Cr</th><th>Standard normal variate Za</th></tr>';
     const za = {50:0,90:1.288,95:1.645,99:2.326,99.9:3.091,99.99:3.719};
     for(const[k,v] of Object.entries(RELIABILITY)){
       h+=`<tr><td>${k}%</td><td><b>${v}</b></td><td>${za[k]||'â€”'}</td></tr>`;
     }
     h+='</table>';
     return h;
   },
   formula:'Cr = 1 âˆ’ 0.08Â·Za\nwhere Za = standard normal variate'
  },

  // â”€â”€ FLUID FLOW & LUBRICATION â”€â”€
  {id:'pipeflow', name:'Pipe Flow Pressure Drop', cat:'Fluid Flow & Lubrication', color:'var(--cat-fluid)', icon:'ğŸŒŠ',
   desc:'Darcy-Weisbach pressure drop with Swamee-Jain friction factor. Laminar and turbulent flow.',
   inputs:[
     {id:'D',label:'Pipe inner diameter',unit:'mm',val:25},
     {id:'L_pipe',label:'Pipe length',unit:'m',val:50},
     {id:'Q',label:'Flow rate',unit:'L/min',val:30},
     {id:'rho',label:'Fluid density',unit:'kg/mÂ³',val:1000},
     {id:'mu_f',label:'Dynamic viscosity',unit:'PaÂ·s',val:0.001},
     {id:'eps',label:'Roughness Îµ',unit:'mm',val:0.045, hint:'Steel â‰ˆ 0.045, PVC â‰ˆ 0.0015'},
   ],
   outputs:['v|Flow velocity|m/s','Re|Reynolds number|â€”','regime|Flow regime|','f|Friction factor|â€”','dP|Pressure drop|bar','dP_Pa|Pressure drop|Pa'],
   calc(v){
     const D_m = v.D/1000;
     const A = Math.PI*D_m*D_m/4;
     const Q_m3s = v.Q/60000;
     const vel = Q_m3s/A;
     const Re = v.rho*vel*D_m/v.mu_f;
     let f, regime;
     if(Re<2300){
       f = 64/Re;
       regime = 'Laminar';
     } else {
       const e_D = (v.eps/1000)/D_m;
       const arg = e_D/3.7 + 5.74/Math.pow(Re,0.9);
       f = 0.25/Math.pow(Math.log10(arg),2);
       regime = Re<4000?'Transitional':'Turbulent';
     }
     const dP = f*(v.L_pipe/D_m)*(v.rho*vel*vel/2);
     return {'v':vel.toFixed(3),'Re':Re.toFixed(0),'regime':regime,'f':f.toFixed(6),'dP':(dP/1e5).toFixed(4),'dP_Pa':dP.toFixed(0)};
   },
   formula:'v = Q / A\nRe = ÏvD/Âµ\nLaminar (Re<2300): f = 64/Re\nTurbulent: f = 0.25/[logâ‚â‚€(Îµ/3.7D + 5.74/Reâ°Â·â¹)]Â²\nÎ”P = fÂ·(L/D)Â·(ÏvÂ²/2)'
  },

  {id:'pipeflow_air', name:'Compressed Air Pipe Flow', cat:'Fluid Flow & Lubrication', color:'var(--cat-fluid)', icon:'ğŸŒŠ',
   desc:'Pressure drop in compressed air lines using ideal gas law for density.',
   inputs:[
     {id:'P_bar',label:'Inlet pressure (gauge)',unit:'bar',val:6},
     {id:'T_C',label:'Air temperature',unit:'Â°C',val:20},
     {id:'D',label:'Pipe inner diameter',unit:'mm',val:25},
     {id:'L_pipe',label:'Pipe length',unit:'m',val:50},
     {id:'Q_nl',label:'Flow rate (free air)',unit:'NL/min',val:500},
     {id:'eps',label:'Roughness Îµ',unit:'mm',val:0.045},
   ],
   outputs:['rho|Air density at pressure|kg/mÂ³','v|Flow velocity|m/s','Re|Reynolds number|â€”','dP|Pressure drop|bar'],
   calc(v){
     const P_abs = (v.P_bar+1.013)*1e5;
     const T_K = v.T_C+273.15;
     const rho = P_abs/(287*T_K);
     const Q_actual = (v.Q_nl/60000)*(1.013e5/P_abs)*(T_K/293.15);
     const D_m = v.D/1000;
     const A = Math.PI*D_m*D_m/4;
     const vel = Q_actual/A;
     const mu_air = 1.81e-5;
     const Re = rho*vel*D_m/mu_air;
     let f;
     if(Re<2300) f=64/Re;
     else { const arg=(v.eps/1000)/(3.7*D_m)+5.74/Math.pow(Re,0.9); f=0.25/Math.pow(Math.log10(arg),2); }
     const dP = f*(v.L_pipe/D_m)*(rho*vel*vel/2);
     return {'rho':rho.toFixed(2),'v':vel.toFixed(2),'Re':Re.toFixed(0),'dP':(dP/1e5).toFixed(4)};
   },
   formula:'Ï = P_abs / (RÂ·T) [R=287 J/kgÂ·K]\nQ_actual = Q_NL Â· (P_atm/P_abs) Â· (T/T_ref)\nÎ”P = fÂ·(L/D)Â·ÏvÂ²/2'
  },

  {id:'barus', name:'Pressure-Viscosity (Barus/Roelands)', cat:'Fluid Flow & Lubrication', color:'var(--cat-fluid)', icon:'ğŸŒŠ',
   desc:'Oil viscosity under pressure. Barus (exponential) and Roelands (power-law) models for EHL calculations.',
   inputs:[
     {id:'eta0',label:'Base viscosity Î·â‚€',unit:'PaÂ·s',val:0.04},
     {id:'p_visc',label:'Pressure',unit:'MPa',val:500},
     {id:'alpha_pv',label:'Pressure-visc. coeff. Î±',unit:'GPaâ»Â¹',val:22},
     {id:'Z',label:'Roelands index Z',unit:'â€”',val:0.68},
   ],
   outputs:['eta_barus|Viscosity (Barus)|PaÂ·s','eta_roelands|Viscosity (Roelands)|PaÂ·s','ratio_b|Viscosity increase (Barus)|Ã—','ratio_r|Viscosity increase (Roelands)|Ã—'],
   calc(v){
     const alpha_Pa = v.alpha_pv*1e-9;
     const p_Pa = v.p_visc*1e6;
     const eta_b = v.eta0*Math.exp(alpha_Pa*p_Pa);
     const p0_roel = 1.98e8;
     const lnEta0 = Math.log(v.eta0);
     const eta_r = v.eta0*Math.exp((lnEta0+9.67)*(-1+Math.pow(1+p_Pa/p0_roel,v.Z)));
     return {'eta_barus':eta_b.toExponential(3),'eta_roelands':eta_r.toExponential(3),'ratio_b':(eta_b/v.eta0).toExponential(2),'ratio_r':(eta_r/v.eta0).toExponential(2)};
   },
   formula:'Barus:   Î· = Î·â‚€ Â· exp(Î±Â·p)\nRoelands: Î· = Î·â‚€ Â· exp[(ln Î·â‚€ + 9.67)Â·(âˆ’1 + (1+p/pâ‚€)^Z)]\n  pâ‚€ = 198 MPa'
  },

  // â”€â”€ DYNAMICS â”€â”€
  {id:'damping', name:'Viscous Damping', cat:'Dynamics & Vibration', color:'var(--cat-dynamics)', icon:'ã€°ï¸',
   desc:'Viscous damping force and annular gap damping coefficient.',
   inputs:[
     {id:'mu_d',label:'Dynamic viscosity Âµ',unit:'PaÂ·s',val:0.05},
     {id:'D_d',label:'Piston/shaft diameter',unit:'mm',val:40},
     {id:'h_gap',label:'Radial gap',unit:'mm',val:0.5},
     {id:'L_d',label:'Bearing/piston length',unit:'mm',val:50},
     {id:'eps_d',label:'Eccentricity ratio Îµ',unit:'â€”',val:0, hint:'0=concentric, <1'},
     {id:'vel',label:'Velocity',unit:'m/s',val:0.1},
   ],
   outputs:['c|Damping coefficient|NÂ·s/m','F_damp|Damping force|N','P_diss|Power dissipated|W'],
   calc(v){
     const D=v.D_d/1000, h=v.h_gap/1000, L=v.L_d/1000;
     const eccFactor = Math.pow(1-v.eps_d*v.eps_d, 1.5);
     const c = Math.PI*v.mu_d*D*D*D*L/(4*h*h*h*eccFactor);
     const F = c*v.vel;
     const P = c*v.vel*v.vel;
     return {'c':c.toFixed(1),'F_damp':F.toFixed(2),'P_diss':P.toFixed(3)};
   },
   formula:'c = Ï€Â·ÂµÂ·DÂ³Â·L / [4Â·hÂ³Â·(1âˆ’ÎµÂ²)^(3/2)]\nF = cÂ·v\nP = cÂ·vÂ²'
  },

  // â”€â”€ POWER TRANSMISSION â”€â”€
  {id:'t14_shaft', name:'Drive Shaft Design', cat:'Power Transmission', color:'var(--cat-power)', icon:'âš¡',
   desc:'Shaft diameter from transmitted power. Torque, bending, and combined loading (von Mises).',
   inputs:[
     {id:'Pw',label:'Power',unit:'kW',val:15},
     {id:'n_rpm',label:'Speed',unit:'rpm',val:1500},
     {id:'M_b',label:'Bending moment',unit:'NÂ·m',val:150},
     {id:'tau_allow',label:'Allowable shear stress',unit:'MPa',val:55},
   ],
   outputs:['T|Torque|NÂ·m','d_torsion|Min âŒ€ (torsion only)|mm','sigma_eq|Equiv. stress (von Mises)|MPa','d_combined|Min âŒ€ (combined)|mm'],
   calc(v){
     const T = v.Pw*1000*60/(2*Math.PI*v.n_rpm);
     const d_t = Math.pow(16*T*1000/(Math.PI*v.tau_allow),1/3);
     const d_c = Math.pow(16/(Math.PI*v.tau_allow)*Math.sqrt(v.M_b*v.M_b*1e6+0.75*T*T*1e6),1/3);
     const sigma_eq = v.tau_allow; // at design point
     return {'T':T.toFixed(1),'d_torsion':d_t.toFixed(1),'sigma_eq':sigma_eq.toFixed(0),'d_combined':d_c.toFixed(1)};
   },
   formula:'T = PÂ·60 / (2Ï€Â·n)  [P in W, T in NÂ·m]\nd = âˆ›(16T / Ï€Ï„_allow)  [torsion only]\nd = âˆ›(16/Ï€Ï„ Â· âˆš(MÂ² + Â¾TÂ²))  [combined]'
  },

  {id:'t14_bending', name:'Shaft Bending Stress', cat:'Power Transmission', color:'var(--cat-power)', icon:'âš¡',
   desc:'Bending stress in a circular shaft / axle.',
   inputs:[
     {id:'M_bend',label:'Bending moment',unit:'NÂ·m',val:500},
     {id:'d_shaft',label:'Shaft diameter',unit:'mm',val:40},
     {id:'Sy_shaft',label:'Yield strength',unit:'MPa',val:350},
   ],
   outputs:['sigma_b|Bending stress|MPa','SF|Safety factor|â€”','I|Moment of inertia|mmâ´'],
   calc(v){
     const d=v.d_shaft;
     const I = Math.PI*Math.pow(d,4)/64;
     const sigma = 32*v.M_bend*1000/(Math.PI*Math.pow(d,3));
     return {'sigma_b':sigma.toFixed(1),'SF':(v.Sy_shaft/sigma).toFixed(2),'I':I.toFixed(0)};
   },
   formula:'Ïƒb = 32M / (Ï€Â·dÂ³)\nI = Ï€Â·dâ´ / 64\nSF = Ïƒ_yield / Ïƒb'
  },

  {id:'spring', name:'Helical Spring Design', cat:'Power Transmission', color:'var(--cat-power)', icon:'âš¡',
   desc:'Round wire helical compression/tension spring calculator.',
   inputs:[
     {id:'dw',label:'Wire diameter',unit:'mm',val:3},
     {id:'Dm',label:'Mean coil diameter',unit:'mm',val:20},
     {id:'na',label:'Active coils',unit:'â€”',val:8},
     {id:'F_spring',label:'Applied force',unit:'N',val:100},
     {id:'G',label:'Shear modulus G',unit:'MPa',val:81500, hint:'Steel â‰ˆ 81500'},
   ],
   outputs:['C|Spring index C|â€”','k|Spring rate|N/mm','delta_s|Deflection|mm','tau_s|Shear stress (Wahl)|MPa','Kw|Wahl correction factor|â€”'],
   calc(v){
     const C = v.Dm/v.dw;
     const Kw = (4*C-1)/(4*C-4)+0.615/C;
     const k = v.G*Math.pow(v.dw,4)/(8*Math.pow(v.Dm,3)*v.na);
     const delta = v.F_spring/k;
     const tau = Kw*8*v.F_spring*v.Dm/(Math.PI*Math.pow(v.dw,3));
     return {'C':C.toFixed(2),'k':k.toFixed(2),'delta_s':delta.toFixed(2),'tau_s':tau.toFixed(0),'Kw':Kw.toFixed(3)};
   },
   formula:'C = D/d (spring index)\nKw = (4Câˆ’1)/(4Câˆ’4) + 0.615/C\nk = GÂ·dâ´ / (8Â·DÂ³Â·na)\nÏ„ = Kw Â· 8FD / (Ï€Â·dÂ³)'
  },

  // â”€â”€ MATERIAL PROPERTIES â”€â”€
  {id:'uts', name:'Material Properties Reference', cat:'Material Properties', color:'var(--cat-material)', icon:'ğŸ“Š',
   desc:'Mechanical properties of common engineering metals and alloys.',
   inputs:[],
   outputs:[],
   calc(){ return {}; },
   customRender(){
     const data = [
       ['Steel C45 (1045)','210','0.30','580','340','190'],
       ['Steel 42CrMo4 (4140)','210','0.30','1000','750','310'],
       ['Steel 100Cr6 (52100)','210','0.30','2000','1700','â€”'],
       ['Stainless 304','193','0.29','520','210','180'],
       ['Stainless 316','193','0.30','560','240','190'],
       ['Cast Iron GG25','100â€“150','0.25','250','â€”','100'],
       ['Aluminum 6061-T6','69','0.33','310','275','95'],
       ['Aluminum 7075-T6','72','0.33','570','500','160'],
       ['Titanium Ti-6Al-4V','114','0.34','950','880','â€”'],
       ['Brass CuZn37','100','0.34','420','250','150'],
       ['Bronze CuSn8','110','0.34','400','200','160'],
       ['Copper Cu-ETP','120','0.34','220','70','65'],
     ];
     let h = '<table class="ref-table"><tr><th>Material</th><th>E (GPa)</th><th>Î½</th><th>Su (MPa)</th><th>Sy (MPa)</th><th>Se (MPa)</th></tr>';
     data.forEach(r=>{h+=`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`;});
     h+='</table><p style="margin-top:10px;font-size:.78rem;color:#a1a1aa;">E = Young\'s modulus, Î½ = Poisson\'s ratio, Su = ultimate tensile, Sy = yield, Se â‰ˆ endurance limit (rotating bending)</p>';
     return h;
   },
   formula:'Se â‰ˆ 0.5Â·Su for Su â‰¤ 1400 MPa (steels)\nG = E / (2Â·(1+Î½))'
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HEAT TRANSFER CALCULATORS (VDI Heat Atlas)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // --- Forced Convection ---
  {id:'ht_forced', name:'Forced Convection in Tubes', cat:'Heat Transfer', color:'var(--cat-heat)', icon:'ğŸ”¥',
   desc:'Gnielinski correlation for turbulent flow, VDI approach for laminar and transition regimes in circular tubes (VDI G1).',
   inputs:[], outputs:[],
   calc(){ return {}; },
   fullCustomRender(){
     return `
<div class="calc-section">
  <h3><span class="dot input-dot"></span>Fluid &amp; Conditions <span class="ht-info-tag">VDI G1</span></h3>
  <div class="field-grid">
    <div class="field"><label>Fluid</label>
      <select id="fc-fluid"><option value="water">Water (liquid)</option><option value="air">Air (1 bar)</option><option value="custom">Custom (manual)</option></select></div>
    <div class="field"><label>Bulk temperature <span class="unit">[Â°C]</span></label>
      <input type="number" id="fc-Tb" value="60" step="1"></div>
  </div>
  <div id="fc-props-display" class="ht-props-display"></div>
  <div id="fc-custom-props" style="display:none">
    <div class="ht-section-label">Manual fluid properties</div>
    <div class="field-grid">
      <div class="field"><label>&rho; <span class="unit">[kg/mÂ³]</span></label><input type="number" id="fc-rho" step="any"></div>
      <div class="field"><label>c<sub>p</sub> <span class="unit">[J/(kgÂ·K)]</span></label><input type="number" id="fc-cp" step="any"></div>
      <div class="field"><label>&lambda; <span class="unit">[W/(mÂ·K)]</span></label><input type="number" id="fc-lambda" step="any"></div>
      <div class="field"><label>&mu; <span class="unit">[PaÂ·s]</span></label><input type="number" id="fc-mu" step="any"></div>
      <div class="field"><label>Pr <span class="unit">[-]</span></label><input type="number" id="fc-Pr" step="any"></div>
      <div class="field"><label>Pr<sub>w</sub> at wall T <span class="unit">[-]</span></label><input type="number" id="fc-Prw" step="any"></div>
    </div>
  </div>
  <hr class="ht-sep">
  <div class="field-grid">
    <div class="field"><label>Boundary condition</label>
      <select id="fc-bc"><option value="constT">Constant wall temperature</option><option value="constQ">Constant heat flux</option></select></div>
    <div class="field"><label>Wall temperature <span class="unit">[Â°C]</span></label>
      <input type="number" id="fc-Tw" value="100" step="1"></div>
  </div>
  <div class="field-grid">
    <div class="field"><label>Inner diameter d <span class="unit">[mm]</span></label><input type="number" id="fc-d" value="25" step="0.1"></div>
    <div class="field"><label>Pipe length L <span class="unit">[m]</span></label><input type="number" id="fc-L" value="2" step="0.1"></div>
    <div class="field"><label>Mean velocity <span class="unit">[m/s]</span></label><input type="number" id="fc-v" value="1.0" step="0.01"></div>
  </div>
  <div class="ht-btn-row">
    <button class="calc-btn" id="fc-calc-btn">Calculate</button>
    <button class="ht-btn-outline" id="fc-clear-btn">Clear</button>
  </div>
  <div id="fc-results" class="ht-results">
    <h3>Results</h3>
    <div id="fc-results-grid" class="ht-result-grid"></div>
    <div id="fc-results-note" class="ht-result-note"></div>
  </div>
</div>`;
   },
   customInit(){
     document.getElementById('fc-fluid').addEventListener('change', ()=>htUpdateFluidProps('fc'));
     document.getElementById('fc-Tb').addEventListener('input', ()=>htUpdateFluidProps('fc'));
     document.getElementById('fc-calc-btn').addEventListener('click', htCalcForced);
     document.getElementById('fc-clear-btn').addEventListener('click', ()=>htClearResults('fc'));
     htUpdateFluidProps('fc');
   },
   formula:'Turbulent (Reâ‰¥10â´): Nu = (Î¾/8)Â·ReÂ·Pr / [1 + 12.7Â·âˆš(Î¾/8)Â·(PrÂ²áŸÂ³âˆ’1)] Â· [1+(d/L)Â²áŸÂ³] Â· K\nKonakov: Î¾ = (1.8Â·logâ‚â‚€(Re) âˆ’ 1.5)â»Â²\nLaminar (Re<2300): Nu = Â³âˆš(Nuâ‚Â³ + 0.7Â³ + (Nuâ‚‚âˆ’0.7)Â³ + Nuâ‚ƒÂ³)\n  Nuâ‚ = 3.66 (const Tw) or 4.364 (const qÌ‡)\n  Nuâ‚‚ = 1.615Â·(ReÂ·PrÂ·d/L)Â¹áŸÂ³\n  Nuâ‚ƒ = (2/(1+22Â·Pr))Â¹áŸâ¶ Â· (ReÂ·PrÂ·d/L)â°Â·âµ'
  },

  // --- Free (Natural) Convection ---
  {id:'ht_free', name:'Free (Natural) Convection', cat:'Heat Transfer', color:'var(--cat-heat)', icon:'ğŸ”¥',
   desc:'Churchill & Chu correlations for vertical plates, horizontal plates, and horizontal cylinders (VDI F2).',
   inputs:[], outputs:[],
   calc(){ return {}; },
   fullCustomRender(){
     return `
<div class="calc-section">
  <h3><span class="dot input-dot"></span>Fluid &amp; Geometry <span class="ht-info-tag">VDI F2</span></h3>
  <div class="field-grid">
    <div class="field"><label>Fluid</label>
      <select id="nc-fluid"><option value="water">Water (liquid)</option><option value="air" selected>Air (1 bar)</option><option value="custom">Custom (manual)</option></select></div>
    <div class="field"><label>Film temperature T<sub>f</sub> <span class="unit">[Â°C]</span></label>
      <input type="number" id="nc-Tf" value="50" step="1"></div>
  </div>
  <div id="nc-props-display" class="ht-props-display"></div>
  <div id="nc-custom-props" style="display:none">
    <div class="ht-section-label">Manual fluid properties (at film temperature)</div>
    <div class="field-grid">
      <div class="field"><label>&rho; <span class="unit">[kg/mÂ³]</span></label><input type="number" id="nc-rho" step="any"></div>
      <div class="field"><label>c<sub>p</sub> <span class="unit">[J/(kgÂ·K)]</span></label><input type="number" id="nc-cp" step="any"></div>
      <div class="field"><label>&lambda; <span class="unit">[W/(mÂ·K)]</span></label><input type="number" id="nc-lambda" step="any"></div>
      <div class="field"><label>&mu; <span class="unit">[PaÂ·s]</span></label><input type="number" id="nc-mu" step="any"></div>
      <div class="field"><label>Pr <span class="unit">[-]</span></label><input type="number" id="nc-Pr" step="any"></div>
      <div class="field"><label>&beta; <span class="unit">[1/K]</span></label><input type="number" id="nc-beta" step="any"></div>
    </div>
  </div>
  <hr class="ht-sep">
  <div class="field-grid">
    <div class="field"><label>Geometry</label>
      <select id="nc-geom"><option value="vert-plate">Vertical flat plate</option><option value="horiz-plate-up">Horizontal plate (hot side up)</option><option value="horiz-plate-down">Horizontal plate (hot side down)</option><option value="horiz-cyl">Horizontal cylinder</option></select></div>
    <div class="field"><label id="nc-Lchar-label">Height L <span class="unit">[m]</span></label>
      <input type="number" id="nc-Lchar" value="0.5" step="0.01"></div>
  </div>
  <div class="field-grid">
    <div class="field"><label>Surface temperature T<sub>s</sub> <span class="unit">[Â°C]</span></label><input type="number" id="nc-Ts" value="80" step="1"></div>
    <div class="field"><label>Ambient temperature T<sub>&infin;</sub> <span class="unit">[Â°C]</span></label><input type="number" id="nc-Tinf" value="20" step="1"></div>
  </div>
  <div class="ht-btn-row">
    <button class="calc-btn" id="nc-calc-btn">Calculate</button>
    <button class="ht-btn-outline" id="nc-clear-btn">Clear</button>
  </div>
  <div id="nc-results" class="ht-results">
    <h3>Results</h3>
    <div id="nc-results-grid" class="ht-result-grid"></div>
    <div id="nc-results-note" class="ht-result-note"></div>
  </div>
</div>`;
   },
   customInit(){
     document.getElementById('nc-fluid').addEventListener('change', ()=>htUpdateFluidProps('nc'));
     document.getElementById('nc-Tf').addEventListener('input', ()=>htUpdateFluidProps('nc'));
     document.getElementById('nc-geom').addEventListener('change', htToggleNCFields);
     document.getElementById('nc-calc-btn').addEventListener('click', htCalcFree);
     document.getElementById('nc-clear-btn').addEventListener('click', ()=>htClearResults('nc'));
     htUpdateFluidProps('nc');
     htToggleNCFields();
   },
   formula:'Vertical plate (Churchill & Chu):\n  Nu = [0.825 + 0.387Â·(RaÂ·fâ‚)Â¹áŸâ¶]Â²\n  fâ‚(Pr) = [1 + (0.492/Pr)â¹áŸÂ¹â¶]â»Â¹â¶áŸâ¹\nHorizontal cylinder:\n  Nu = [0.60 + 0.387Â·(RaÂ·fâ‚)Â¹áŸâ¶]Â²\nRa = GrÂ·Pr = gÂ·Î²Â·Î”TÂ·LÂ³/Î½Â² Â· Pr'
  },

  // --- Steady-State Conduction ---
  {id:'ht_cond', name:'Steady-State Heat Conduction', cat:'Heat Transfer', color:'var(--cat-heat)', icon:'ğŸ”¥',
   desc:'Through flat walls, cylindrical walls, and spherical shells with multi-layer support and optional convective BCs (VDI E).',
   inputs:[], outputs:[],
   calc(){ return {}; },
   fullCustomRender(){
     return `
<div class="calc-section">
  <h3><span class="dot input-dot"></span>Geometry &amp; Conditions <span class="ht-info-tag">VDI E</span></h3>
  <div class="field-grid">
    <div class="field"><label>Geometry</label>
      <select id="cd-geom"><option value="flat">Flat wall (plane)</option><option value="cylinder">Cylindrical wall</option><option value="sphere">Spherical shell</option></select></div>
    <div class="field" id="cd-area-group"><label>Wall area A <span class="unit">[mÂ²]</span></label>
      <input type="number" id="cd-A" value="1" step="0.01"></div>
  </div>
  <div id="cd-cyl-dims" style="display:none">
    <div class="field-grid">
      <div class="field"><label>Pipe length <span class="unit">[m]</span></label><input type="number" id="cd-pipe-L" value="1" step="0.1"></div>
      <div class="field"><label>Inner radius r<sub>i</sub> <span class="unit">[mm]</span></label><input type="number" id="cd-ri" value="12.5" step="0.1"></div>
    </div>
  </div>
  <div id="cd-sph-dims" style="display:none">
    <div class="field-grid">
      <div class="field"><label>Inner radius r<sub>i</sub> <span class="unit">[mm]</span></label><input type="number" id="cd-sri" value="50" step="0.1"></div>
    </div>
  </div>
  <div class="field-grid">
    <div class="field"><label>Hot side T<sub>1</sub> <span class="unit">[Â°C]</span></label><input type="number" id="cd-T1" value="200" step="1"></div>
    <div class="field"><label>Cold side T<sub>2</sub> <span class="unit">[Â°C]</span></label><input type="number" id="cd-T2" value="30" step="1"></div>
  </div>
  <hr class="ht-sep">
  <div class="ht-section-label">Layers (inner &rarr; outer)</div>
  <div id="cd-layers">
    <div class="field-grid layer-row" data-layer="0">
      <div class="field"><label>Thickness <span class="unit">[mm]</span></label><input type="number" class="cd-layer-t" value="5" step="0.1"></div>
      <div class="field"><label>Conductivity &lambda; <span class="unit">[W/(mÂ·K)]</span></label><input type="number" class="cd-layer-k" value="50" step="0.01"></div>
    </div>
  </div>
  <div class="ht-btn-row" style="margin-bottom:12px">
    <button class="ht-btn-outline ht-btn-sm" id="cd-add-layer">+ Add Layer</button>
    <button class="ht-btn-outline ht-btn-sm" id="cd-remove-layer">&minus; Remove Layer</button>
  </div>
  <div class="ht-section-label">Convective boundary conditions (optional)</div>
  <div class="field-grid">
    <div class="field"><label>h<sub>inner</sub> <span class="unit">[W/(mÂ²Â·K)]</span></label><input type="number" id="cd-hi" placeholder="âˆ (leave empty to skip)" step="1"></div>
    <div class="field"><label>h<sub>outer</sub> <span class="unit">[W/(mÂ²Â·K)]</span></label><input type="number" id="cd-ho" placeholder="âˆ (leave empty to skip)" step="1"></div>
  </div>
  <div class="ht-btn-row">
    <button class="calc-btn" id="cd-calc-btn">Calculate</button>
    <button class="ht-btn-outline" id="cd-clear-btn">Clear</button>
  </div>
  <div id="cd-results" class="ht-results">
    <h3>Results</h3>
    <div id="cd-results-grid" class="ht-result-grid"></div>
    <div id="cd-results-note" class="ht-result-note"></div>
  </div>
</div>`;
   },
   customInit(){
     document.getElementById('cd-geom').addEventListener('change', htToggleCDFields);
     document.getElementById('cd-add-layer').addEventListener('click', htAddLayer);
     document.getElementById('cd-remove-layer').addEventListener('click', htRemoveLayer);
     document.getElementById('cd-calc-btn').addEventListener('click', htCalcConduction);
     document.getElementById('cd-clear-btn').addEventListener('click', ()=>htClearResults('cd'));
     htToggleCDFields();
   },
   formula:'Flat wall: QÌ‡ = Î”T / R_total,  R = Î£(t_i / (Î»_iÂ·A))\nCylindrical: R = ln(r_outer/r_inner) / (2Ï€Â·LÂ·Î»)\nSpherical: R = (1/r_i âˆ’ 1/r_o) / (4Ï€Â·Î»)\nConvective: R_conv = 1/(hÂ·A)\nU = 1/(R_totalÂ·A)'
  },

  // --- Thermal Radiation ---
  {id:'ht_rad', name:'Thermal Radiation', cat:'Heat Transfer', color:'var(--cat-heat)', icon:'ğŸ”¥',
   desc:'Stefan-Boltzmann law, exchange between grey surfaces, and common view factor configurations (VDI K).',
   inputs:[], outputs:[],
   calc(){ return {}; },
   fullCustomRender(){
     return `
<div class="calc-section">
  <h3><span class="dot input-dot"></span>Configuration &amp; Surfaces <span class="ht-info-tag">VDI K</span></h3>
  <div class="field-grid">
    <div class="field"><label>Configuration</label>
      <select id="rd-config"><option value="single">Single surface to surroundings</option><option value="parallel">Two infinite parallel plates</option><option value="enclosed">Small body enclosed by large surface</option><option value="arbitrary">Two arbitrary surfaces (with view factor)</option></select></div>
  </div>
  <div class="field-grid">
    <div class="field"><label>T<sub>1</sub> (hot surface) <span class="unit">[Â°C]</span></label><input type="number" id="rd-T1" value="400" step="1"></div>
    <div class="field"><label>T<sub>2</sub> (cold / surroundings) <span class="unit">[Â°C]</span></label><input type="number" id="rd-T2" value="25" step="1"></div>
  </div>
  <div class="field-grid">
    <div class="field"><label>&epsilon;<sub>1</sub> (emissivity surface 1) <span class="unit">[-]</span></label><input type="number" id="rd-eps1" value="0.9" step="0.01" min="0" max="1"></div>
    <div class="field" id="rd-eps2-group"><label>&epsilon;<sub>2</sub> (emissivity surface 2) <span class="unit">[-]</span></label><input type="number" id="rd-eps2" value="0.9" step="0.01" min="0" max="1"></div>
  </div>
  <div class="field-grid">
    <div class="field"><label>Area A<sub>1</sub> <span class="unit">[mÂ²]</span></label><input type="number" id="rd-A1" value="1" step="0.01"></div>
    <div class="field" id="rd-F12-group"><label>View factor F<sub>12</sub> <span class="unit">[-]</span></label><input type="number" id="rd-F12" value="1" step="0.01" min="0" max="1"></div>
  </div>
  <div class="ht-btn-row">
    <button class="calc-btn" id="rd-calc-btn">Calculate</button>
    <button class="ht-btn-outline" id="rd-clear-btn">Clear</button>
  </div>
  <div id="rd-results" class="ht-results">
    <h3>Results</h3>
    <div id="rd-results-grid" class="ht-result-grid"></div>
    <div id="rd-results-note" class="ht-result-note"></div>
  </div>
</div>`;
   },
   customInit(){
     document.getElementById('rd-config').addEventListener('change', htToggleRDFields);
     document.getElementById('rd-calc-btn').addEventListener('click', htCalcRadiation);
     document.getElementById('rd-clear-btn').addEventListener('click', ()=>htClearResults('rd'));
     htToggleRDFields();
   },
   formula:'Single surface: QÌ‡ = Îµâ‚Â·ÏƒÂ·AÂ·(Tâ‚â´ âˆ’ Tâ‚‚â´)\nParallel plates: Îµ_eff = 1/(1/Îµâ‚ + 1/Îµâ‚‚ âˆ’ 1)\nArbitrary: QÌ‡ = Aâ‚Â·Fâ‚â‚‚Â·Îµ_effÂ·ÏƒÂ·(Tâ‚â´ âˆ’ Tâ‚‚â´)\nÏƒ = 5.670374419 Ã— 10â»â¸ W/(mÂ²Â·Kâ´)'
  },

  // --- Heat Exchanger ---
  {id:'ht_hx', name:'Heat Exchanger Design & Rating', cat:'Heat Transfer', color:'var(--cat-heat)', icon:'ğŸ”¥',
   desc:'LMTD and Îµ-NTU methods with F-correction factors for counterflow, parallel flow, crossflow, and shell-and-tube (VDI C/D).',
   inputs:[], outputs:[],
   calc(){ return {}; },
   fullCustomRender(){
     return `
<div class="calc-section">
  <h3><span class="dot input-dot"></span>Exchanger Setup <span class="ht-info-tag">VDI C/D</span></h3>
  <div class="field-grid">
    <div class="field"><label>Calculation mode</label>
      <select id="hx-mode"><option value="design">Design â€” find required area A</option><option value="rating">Rating â€” find outlet temps &amp; Q</option><option value="check">Performance check â€” all temps known</option></select></div>
    <div class="field"><label>Configuration</label>
      <select id="hx-config"><option value="counter">Counterflow</option><option value="parallel">Parallel flow (co-current)</option><option value="cross-UU">Crossflow (both unmixed)</option><option value="cross-MU">Crossflow (C_max mixed, C_min unmixed)</option><option value="cross-UM">Crossflow (C_min mixed, C_max unmixed)</option><option value="shell-1-2">Shell &amp; tube (1-2 TEMA E)</option><option value="shell-1-4">Shell &amp; tube (1-4)</option></select></div>
  </div>
  <hr class="ht-sep">
  <div class="ht-section-label">Hot side</div>
  <div class="field-grid">
    <div class="field"><label>T<sub>h,in</sub> <span class="unit">[Â°C]</span></label><input type="number" id="hx-Thi" value="150" step="1"></div>
    <div class="field" id="hx-Tho-group"><label>T<sub>h,out</sub> <span class="unit">[Â°C]</span></label><input type="number" id="hx-Tho" value="90" step="1"></div>
    <div class="field"><label>á¹<sub>h</sub>Â·c<sub>p,h</sub> (= C<sub>h</sub>) <span class="unit">[W/K]</span></label><input type="number" id="hx-Ch" value="5000" step="100"></div>
  </div>
  <div class="ht-section-label">Cold side</div>
  <div class="field-grid">
    <div class="field"><label>T<sub>c,in</sub> <span class="unit">[Â°C]</span></label><input type="number" id="hx-Tci" value="20" step="1"></div>
    <div class="field" id="hx-Tco-group"><label>T<sub>c,out</sub> <span class="unit">[Â°C]</span></label><input type="number" id="hx-Tco" value="80" step="1"></div>
    <div class="field"><label>á¹<sub>c</sub>Â·c<sub>p,c</sub> (= C<sub>c</sub>) <span class="unit">[W/K]</span></label><input type="number" id="hx-Cc" value="4000" step="100"></div>
  </div>
  <hr class="ht-sep">
  <div class="ht-section-label">Heat exchanger parameters</div>
  <div class="field-grid">
    <div class="field"><label>Overall heat transfer coeff. U <span class="unit">[W/(mÂ²Â·K)]</span></label><input type="number" id="hx-U" value="500" step="10"></div>
    <div class="field" id="hx-A-group"><label>Heat transfer area A <span class="unit">[mÂ²]</span></label><input type="number" id="hx-A" value="5" step="0.1"></div>
  </div>
  <div class="field-grid">
    <div class="field"><label>Fouling resistance R<sub>f</sub> (total) <span class="unit">[mÂ²Â·K/W]</span></label><input type="number" id="hx-Rf" value="0" step="0.0001" placeholder="0 = no fouling"></div>
  </div>
  <div class="ht-btn-row">
    <button class="calc-btn" id="hx-calc-btn">Calculate</button>
    <button class="ht-btn-outline" id="hx-clear-btn">Clear</button>
  </div>
  <div id="hx-results" class="ht-results">
    <h3>Results</h3>
    <div id="hx-results-grid" class="ht-result-grid"></div>
    <div id="hx-results-note" class="ht-result-note"></div>
  </div>
</div>`;
   },
   customInit(){
     document.getElementById('hx-mode').addEventListener('change', htToggleHXFields);
     document.getElementById('hx-config').addEventListener('change', htToggleHXFields);
     document.getElementById('hx-calc-btn').addEventListener('click', htCalcHX);
     document.getElementById('hx-clear-btn').addEventListener('click', ()=>htClearResults('hx'));
     htToggleHXFields();
   },
   formula:'Îµ-NTU: Îµ = QÌ‡/QÌ‡_max,  NTU = UÂ·A/C_min,  C_r = C_min/C_max\nCounterflow: Îµ = [1âˆ’exp(âˆ’NTUÂ·(1âˆ’Cr))] / [1âˆ’CrÂ·exp(âˆ’NTUÂ·(1âˆ’Cr))]\nLMTD: QÌ‡ = UÂ·AÂ·FÂ·Î”TLM\nÎ”TLM = (Î”Tâ‚âˆ’Î”Tâ‚‚) / ln(Î”Tâ‚/Î”Tâ‚‚)'
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEAT TRANSFER CALCULATION FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- Toggle/UI helpers for heat calcs ---
function htToggleNCFields() {
  const geom = document.getElementById('nc-geom').value;
  const label = document.getElementById('nc-Lchar-label');
  if (geom === 'vert-plate') label.innerHTML = 'Height L <span class="unit">[m]</span>';
  else if (geom.startsWith('horiz-plate')) label.innerHTML = 'Char. length A/P <span class="unit">[m]</span>';
  else label.innerHTML = 'Outer diameter D <span class="unit">[m]</span>';
}

function htToggleCDFields() {
  const geom = document.getElementById('cd-geom').value;
  document.getElementById('cd-area-group').style.display = (geom === 'flat') ? '' : 'none';
  document.getElementById('cd-cyl-dims').style.display = (geom === 'cylinder') ? 'block' : 'none';
  document.getElementById('cd-sph-dims').style.display = (geom === 'sphere') ? 'block' : 'none';
}

function htAddLayer() {
  const container = document.getElementById('cd-layers');
  const n = container.children.length;
  const row = document.createElement('div');
  row.className = 'field-grid layer-row';
  row.dataset.layer = n;
  row.innerHTML = '<div class="field"><label>Layer '+(n+1)+' thickness <span class="unit">[mm]</span></label><input type="number" class="cd-layer-t" value="20" step="0.1"></div><div class="field"><label>Layer '+(n+1)+' conductivity &lambda; <span class="unit">[W/(mÂ·K)]</span></label><input type="number" class="cd-layer-k" value="0.04" step="0.001"></div>';
  container.appendChild(row);
}

function htRemoveLayer() {
  const container = document.getElementById('cd-layers');
  if (container.children.length > 1) container.removeChild(container.lastElementChild);
}

function htToggleRDFields() {
  const config = document.getElementById('rd-config').value;
  const eps2Group = document.getElementById('rd-eps2-group');
  const f12Group = document.getElementById('rd-F12-group');
  if (config === 'single' || config === 'enclosed') { eps2Group.style.display = 'none'; f12Group.style.display = 'none'; }
  else if (config === 'parallel') { eps2Group.style.display = ''; f12Group.style.display = 'none'; }
  else { eps2Group.style.display = ''; f12Group.style.display = ''; }
}

function htToggleHXFields() {
  const mode = document.getElementById('hx-mode').value;
  const aGroup = document.getElementById('hx-A-group');
  const thoGroup = document.getElementById('hx-Tho-group');
  const tcoGroup = document.getElementById('hx-Tco-group');
  if (mode === 'design') { aGroup.style.display = 'none'; thoGroup.style.display = ''; tcoGroup.style.display = ''; }
  else if (mode === 'rating') { aGroup.style.display = ''; thoGroup.style.display = 'none'; tcoGroup.style.display = 'none'; }
  else { aGroup.style.display = ''; thoGroup.style.display = ''; tcoGroup.style.display = ''; }
}

// --- Forced Convection (VDI G1) ---
function htCalcForced() {
  const fluid = document.getElementById('fc-fluid').value;
  const Tb = parseFloat(document.getElementById('fc-Tb').value);
  const Tw = parseFloat(document.getElementById('fc-Tw').value);
  const d_mm = parseFloat(document.getElementById('fc-d').value);
  const L = parseFloat(document.getElementById('fc-L').value);
  const v = parseFloat(document.getElementById('fc-v').value);
  const bc = document.getElementById('fc-bc').value;
  const d = d_mm / 1000;

  let props, Pr_w;
  if (fluid === 'custom') {
    props = { rho:parseFloat(document.getElementById('fc-rho').value), cp:parseFloat(document.getElementById('fc-cp').value),
      lambda:parseFloat(document.getElementById('fc-lambda').value), mu:parseFloat(document.getElementById('fc-mu').value),
      Pr:parseFloat(document.getElementById('fc-Pr').value) };
    props.nu = props.mu / props.rho;
    Pr_w = parseFloat(document.getElementById('fc-Prw').value) || props.Pr;
  } else {
    props = getFluidProps(fluid, Tb);
    Pr_w = getFluidProps(fluid, Tw).Pr;
  }

  const Re = v * d / props.nu;
  const Pr = props.Pr;
  const xi = (val) => Math.pow(1.8 * Math.log10(val) - 1.5, -2);
  const isGas = (fluid === 'air');
  let K_turb, K_lam;
  if (isGas) {
    const Tb_K = Tb+273.15, Tw_K = Tw+273.15;
    K_turb = Math.pow(Tb_K/Tw_K, 0.45); K_lam = 1;
  } else {
    K_turb = Math.pow(Pr/Pr_w, 0.11);
    const mu_w = fluid !== 'custom' ? getFluidProps(fluid, Tw).mu : props.mu;
    K_lam = Math.pow(props.mu/mu_w, 0.14);
  }

  let Nu, regime;
  function nuLam(Re_val) {
    const Nu1 = (bc === 'constT') ? 3.66 : 4.364;
    const Nu2 = 1.615 * Math.pow(Re_val*Pr*d/L, 1/3);
    const Nu3 = Math.pow(2/(1+22*Pr), 1/6) * Math.pow(Re_val*Pr*d/L, 0.5);
    return Math.pow(Math.pow(Nu1,3)+0.7*0.7*0.7+Math.pow(Math.max(Nu2-0.7,0),3)+Math.pow(Nu3,3), 1/3) * K_lam;
  }
  function nuTurb(Re_val) {
    const f = xi(Re_val);
    const num = (f/8)*Re_val*Pr;
    const den = 1+12.7*Math.sqrt(f/8)*(Math.pow(Pr,2/3)-1);
    const ent = 1+Math.pow(d/L, 2/3);
    return (num/den)*ent*K_turb;
  }

  if (Re < 2300) { regime = 'Laminar'; Nu = nuLam(Re); }
  else if (Re < 10000) {
    regime = 'Transition';
    const gamma = (Re-2300)/(10000-2300);
    Nu = (1-gamma)*nuLam(2300) + gamma*nuTurb(10000);
  } else { regime = 'Turbulent'; Nu = nuTurb(Re); }

  const h = Nu * props.lambda / d;
  const f_darcy = (Re >= 2300) ? xi(Math.max(Re,10000)) : 64/Re;
  const dP = f_darcy * (L/d) * 0.5 * props.rho * v * v;

  const items = [
    {label:'Flow regime', value:regime, full:true},
    {label:'Reynolds number Re', value:htFmt(Re,0)},
    {label:'Prandtl number Pr', value:htFmt(Pr,3)},
    {label:'Pr at wall Pr<sub>w</sub>', value:htFmt(Pr_w,3)},
    {label:'Friction factor &xi;', value:htFmtSci(f_darcy,3)},
    {label:'Correction K', value:htFmt(regime==='Laminar'?K_lam:K_turb,4)},
    {label:'L/d ratio', value:htFmt(L/d,1)},
    {label:'Nusselt number Nu', value:htFmt(Nu,2), highlight:true},
    {label:'Heat transfer coeff. h', value:htFmt(h,1), unit:'W/(m&sup2;&middot;K)', highlight:true},
    {label:'Pressure drop &Delta;p', value:htFmt(dP,0), unit:'Pa'}
  ];
  document.getElementById('fc-results-grid').innerHTML = htResultHTML(items);
  let note = '<strong>Correlation:</strong> ';
  if (regime==='Laminar') note += 'VDI G1 laminar ('+(bc==='constT'?'const. T<sub>w</sub>':'const. q&#x0307;')+'), Nu&#x0304; composite formula.';
  else if (regime==='Turbulent') note += 'Gnielinski (VDI G1), valid for 10<sup>4</sup> &le; Re &le; 10<sup>6</sup>, 0.1 &le; Pr &le; 1000.';
  else note += 'VDI G1 transition interpolation between laminar (Re=2300) and turbulent (Re=10<sup>4</sup>).';
  if (Re > 1e6) note += '<br><strong>Warning:</strong> Re &gt; 10<sup>6</sup>, outside validated range.';
  if (Pr > 1000 || Pr < 0.1) note += '<br><strong>Warning:</strong> Pr outside validated range (0.1&ndash;1000).';
  document.getElementById('fc-results-note').innerHTML = note;
  document.getElementById('fc-results').classList.add('show');
}

// --- Free Convection (VDI F2) ---
function htCalcFree() {
  const fluid = document.getElementById('nc-fluid').value;
  const Tf = parseFloat(document.getElementById('nc-Tf').value);
  const geom = document.getElementById('nc-geom').value;
  const Lc = parseFloat(document.getElementById('nc-Lchar').value);
  const Ts = parseFloat(document.getElementById('nc-Ts').value);
  const Tinf = parseFloat(document.getElementById('nc-Tinf').value);
  const dT = Math.abs(Ts - Tinf);

  let props;
  if (fluid === 'custom') {
    props = { rho:parseFloat(document.getElementById('nc-rho').value), cp:parseFloat(document.getElementById('nc-cp').value),
      lambda:parseFloat(document.getElementById('nc-lambda').value), mu:parseFloat(document.getElementById('nc-mu').value),
      Pr:parseFloat(document.getElementById('nc-Pr').value), beta:parseFloat(document.getElementById('nc-beta').value) };
    props.nu = props.mu / props.rho;
  } else { props = getFluidProps(fluid, Tf); }

  const g = 9.81;
  const Gr = g * props.beta * dT * Math.pow(Lc,3) / Math.pow(props.nu,2);
  const Ra = Gr * props.Pr;
  const f1 = Math.pow(1+Math.pow(0.492/props.Pr, 9/16), -16/9);

  let Nu, corrName;
  if (geom === 'vert-plate') {
    Nu = Math.pow(0.825 + 0.387*Math.pow(Ra*f1, 1/6), 2);
    corrName = 'Churchill & Chu (vertical plate)';
  } else if (geom === 'horiz-cyl') {
    const f1c = Math.pow(1+Math.pow(0.559/props.Pr, 9/16), -16/9);
    Nu = Math.pow(0.60 + 0.387*Math.pow(Ra*f1c, 1/6), 2);
    corrName = 'Churchill & Chu (horizontal cylinder)';
  } else if (geom === 'horiz-plate-up') {
    const RaF = Ra * f1;
    Nu = (RaF <= 2e7) ? 0.766*Math.pow(RaF,1/5) : 0.15*Math.pow(RaF,1/3);
    Nu = Math.max(Nu, 0.6);
    corrName = 'VDI F2 horizontal plate (hot side up)';
  } else {
    Nu = 0.6 * Math.pow(Ra*f1, 1/5);
    Nu = Math.max(Nu, 0.6);
    corrName = 'VDI F2 horizontal plate (hot side down)';
  }

  const h = Nu * props.lambda / Lc;
  const items = [
    {label:'Grashof number Gr', value:htFmtSci(Gr,3)},
    {label:'Rayleigh number Ra', value:htFmtSci(Ra,3)},
    {label:'Prandtl number Pr', value:htFmt(props.Pr,3)},
    {label:'f<sub>1</sub>(Pr)', value:htFmt(f1,4)},
    {label:'&Delta;T', value:htFmt(dT,1), unit:'K'},
    {label:'&beta;', value:htFmtSci(props.beta,3), unit:'1/K'},
    {label:'Nusselt number Nu', value:htFmt(Nu,2), highlight:true},
    {label:'Heat transfer coeff. h', value:htFmt(h,2), unit:'W/(m&sup2;&middot;K)', highlight:true}
  ];
  document.getElementById('nc-results-grid').innerHTML = htResultHTML(items);
  let note = '<strong>Correlation:</strong> '+corrName;
  if (Ra < 0.1) note += '<br><strong>Note:</strong> Very low Ra; conduction dominates.';
  note += '<br>Flow regime: Ra = '+htFmtSci(Ra,2)+(Ra>1e9?' (turbulent)':' (laminar)');
  document.getElementById('nc-results-note').innerHTML = note;
  document.getElementById('nc-results').classList.add('show');
}

// --- Conduction (VDI E) ---
function htCalcConduction() {
  const geom = document.getElementById('cd-geom').value;
  const T1 = parseFloat(document.getElementById('cd-T1').value);
  const T2 = parseFloat(document.getElementById('cd-T2').value);
  const dT = T1 - T2;
  const hi = parseFloat(document.getElementById('cd-hi').value) || Infinity;
  const ho = parseFloat(document.getElementById('cd-ho').value) || Infinity;
  const thickInputs = document.querySelectorAll('.cd-layer-t');
  const kInputs = document.querySelectorAll('.cd-layer-k');
  const layers = [];
  for (let i = 0; i < thickInputs.length; i++) {
    layers.push({ t:parseFloat(thickInputs[i].value)/1000, k:parseFloat(kInputs[i].value) });
  }

  let Q, R_total, items = [], interfaceTemps = [];

  if (geom === 'flat') {
    const A = parseFloat(document.getElementById('cd-A').value);
    let R_conv_i = (hi===Infinity)?0:1/(hi*A), R_conv_o = (ho===Infinity)?0:1/(ho*A), R_cond = 0;
    const R_layers = layers.map(l => l.t/(l.k*A));
    R_layers.forEach(r => R_cond += r);
    R_total = R_conv_i + R_cond + R_conv_o;
    Q = dT / R_total;
    let T_curr = T1;
    if (hi !== Infinity) { T_curr -= Q*R_conv_i; interfaceTemps.push({name:'Inner wall surface',T:T_curr}); }
    for (let i = 0; i < layers.length; i++) {
      T_curr -= Q*R_layers[i];
      interfaceTemps.push({name: i<layers.length-1 ? 'Interface '+(i+1)+'/'+(i+2) : 'Outer wall surface', T:T_curr});
    }
    const U = 1/(R_total*A);
    items = [
      {label:'Heat flow Q&#x0307;', value:htFmt(Q,2), unit:'W', highlight:true},
      {label:'Heat flux q&#x0307;', value:htFmt(Q/A,2), unit:'W/m&sup2;', highlight:true},
      {label:'Overall U-value', value:htFmt(U,3), unit:'W/(m&sup2;&middot;K)'},
      {label:'Total resistance R', value:htFmtSci(R_total,3), unit:'K/W'}
    ];
    if (R_conv_i > 0) items.push({label:'R<sub>conv,inner</sub>', value:htFmtSci(R_conv_i,3), unit:'K/W'});
    layers.forEach((l,i) => items.push({label:'R<sub>layer '+(i+1)+'</sub> ('+htFmt(l.t*1000,1)+' mm, &lambda;='+htFmt(l.k,3)+')', value:htFmtSci(R_layers[i],3), unit:'K/W', full:true}));
    if (R_conv_o > 0) items.push({label:'R<sub>conv,outer</sub>', value:htFmtSci(R_conv_o,3), unit:'K/W'});
  } else if (geom === 'cylinder') {
    const Lpipe = parseFloat(document.getElementById('cd-pipe-L').value);
    const ri = parseFloat(document.getElementById('cd-ri').value)/1000;
    const PI2L = 2*Math.PI*Lpipe;
    let r = ri; const R_layers = [];
    for (const l of layers) { const r_outer = r+l.t; R_layers.push(Math.log(r_outer/r)/(PI2L*l.k)); r = r_outer; }
    const ro = r;
    const R_conv_i = (hi===Infinity)?0:1/(hi*2*Math.PI*ri*Lpipe);
    const R_conv_o = (ho===Infinity)?0:1/(ho*2*Math.PI*ro*Lpipe);
    let R_cond = 0; R_layers.forEach(rl => R_cond += rl);
    R_total = R_conv_i + R_cond + R_conv_o;
    Q = dT / R_total;
    let T_curr = T1;
    if (hi !== Infinity) { T_curr -= Q*R_conv_i; interfaceTemps.push({name:'Inner surface',T:T_curr}); }
    let r_curr = ri;
    for (let i = 0; i < layers.length; i++) { T_curr -= Q*R_layers[i]; r_curr += layers[i].t; interfaceTemps.push({name:'r = '+htFmt(r_curr*1000,1)+' mm',T:T_curr}); }
    const Ai = 2*Math.PI*ri*Lpipe, Ao = 2*Math.PI*ro*Lpipe;
    items = [
      {label:'Heat flow Q&#x0307;', value:htFmt(Q,2), unit:'W', highlight:true},
      {label:'q&#x0307;<sub>inner</sub>', value:htFmt(Q/Ai,2), unit:'W/m&sup2;'},
      {label:'q&#x0307;<sub>outer</sub>', value:htFmt(Q/Ao,2), unit:'W/m&sup2;'},
      {label:'Outer radius r<sub>o</sub>', value:htFmt(ro*1000,2), unit:'mm'},
      {label:'Total resistance R', value:htFmtSci(R_total,3), unit:'K/W'}
    ];
    if (R_conv_i > 0) items.push({label:'R<sub>conv,inner</sub>', value:htFmtSci(R_conv_i,3), unit:'K/W'});
    layers.forEach((l,i) => items.push({label:'R<sub>layer '+(i+1)+'</sub>', value:htFmtSci(R_layers[i],3), unit:'K/W'}));
    if (R_conv_o > 0) items.push({label:'R<sub>conv,outer</sub>', value:htFmtSci(R_conv_o,3), unit:'K/W'});
  } else {
    const ri = parseFloat(document.getElementById('cd-sri').value)/1000;
    let r = ri; const R_layers = [];
    for (const l of layers) { const r_outer = r+l.t; R_layers.push((1/r - 1/r_outer)/(4*Math.PI*l.k)); r = r_outer; }
    const ro = r;
    const R_conv_i = (hi===Infinity)?0:1/(hi*4*Math.PI*ri*ri);
    const R_conv_o = (ho===Infinity)?0:1/(ho*4*Math.PI*ro*ro);
    let R_cond = 0; R_layers.forEach(rl => R_cond += rl);
    R_total = R_conv_i + R_cond + R_conv_o;
    Q = dT / R_total;
    items = [
      {label:'Heat flow Q&#x0307;', value:htFmt(Q,2), unit:'W', highlight:true},
      {label:'Outer radius r<sub>o</sub>', value:htFmt(ro*1000,2), unit:'mm'},
      {label:'Total resistance R', value:htFmtSci(R_total,3), unit:'K/W'}
    ];
    layers.forEach((l,i) => items.push({label:'R<sub>layer '+(i+1)+'</sub>', value:htFmtSci(R_layers[i],3), unit:'K/W'}));
  }
  interfaceTemps.forEach(it => items.push({label:'T @ '+it.name, value:htFmt(it.T,1), unit:'&deg;C'}));
  document.getElementById('cd-results-grid').innerHTML = htResultHTML(items);
  document.getElementById('cd-results-note').innerHTML =
    '<strong>Geometry:</strong> '+(geom==='flat'?'Plane wall':geom==='cylinder'?'Cylindrical shell':'Spherical shell')+
    ', '+layers.length+' layer(s). Steady-state conduction (VDI E).';
  document.getElementById('cd-results').classList.add('show');
}

// --- Radiation (VDI K) ---
function htCalcRadiation() {
  const sigma = 5.670374419e-8;
  const config = document.getElementById('rd-config').value;
  const T1_C = parseFloat(document.getElementById('rd-T1').value);
  const T2_C = parseFloat(document.getElementById('rd-T2').value);
  const eps1 = parseFloat(document.getElementById('rd-eps1').value);
  const eps2 = parseFloat(document.getElementById('rd-eps2').value) || 1;
  const A1 = parseFloat(document.getElementById('rd-A1').value);
  const F12 = parseFloat(document.getElementById('rd-F12').value) || 1;
  const T1 = T1_C+273.15, T2 = T2_C+273.15;
  const T14 = Math.pow(T1,4), T24 = Math.pow(T2,4);

  let Q, eps_eff, corrName;
  if (config === 'single') { eps_eff = eps1; Q = eps1*sigma*A1*(T14-T24); corrName = 'Single grey surface to black surroundings'; }
  else if (config === 'parallel') { eps_eff = 1/(1/eps1+1/eps2-1); Q = eps_eff*sigma*A1*(T14-T24); corrName = 'Two infinite parallel grey plates'; }
  else if (config === 'enclosed') { eps_eff = eps1; Q = eps1*sigma*A1*(T14-T24); corrName = 'Small body enclosed by large surface (A<sub>1</sub> &lt;&lt; A<sub>2</sub>)'; }
  else { eps_eff = 1/(1/eps1+1/eps2-1); Q = A1*F12*eps_eff*sigma*(T14-T24); corrName = 'Two grey surfaces with view factor'; }

  const q = Q/A1, Eb1 = sigma*T14, Eb2 = sigma*T24;
  const h_rad = (T1 !== T2) ? Q/(A1*(T1_C-T2_C)) : 0;
  const items = [
    {label:'Net heat flow Q&#x0307;<sub>12</sub>', value:htFmt(Q,2), unit:'W', highlight:true},
    {label:'Heat flux q&#x0307;', value:htFmt(q,2), unit:'W/m&sup2;', highlight:true},
    {label:'Radiation h<sub>rad</sub>', value:htFmt(h_rad,2), unit:'W/(m&sup2;&middot;K)'},
    {label:'Effective emissivity &epsilon;<sub>eff</sub>', value:htFmt(eps_eff,4)},
    {label:'E<sub>b,1</sub> = &sigma;T<sub>1</sub>&sup4;', value:htFmt(Eb1,1), unit:'W/m&sup2;'},
    {label:'E<sub>b,2</sub> = &sigma;T<sub>2</sub>&sup4;', value:htFmt(Eb2,1), unit:'W/m&sup2;'},
    {label:'T<sub>1</sub>', value:htFmt(T1,2), unit:'K'},
    {label:'T<sub>2</sub>', value:htFmt(T2,2), unit:'K'},
    {label:'&sigma; (Stefan-Boltzmann)', value:'5.670 &times; 10<sup>-8</sup>', unit:'W/(m&sup2;&middot;K&sup4;)', full:true}
  ];
  document.getElementById('rd-results-grid').innerHTML = htResultHTML(items);
  document.getElementById('rd-results-note').innerHTML =
    '<strong>Configuration:</strong> '+corrName+'.<br>&sigma; = 5.670374419 &times; 10<sup>-8</sup> W/(m&sup2;&middot;K&sup4;) (CODATA 2018).';
  document.getElementById('rd-results').classList.add('show');
}

// --- Heat Exchanger (VDI C/D) ---
function htLmtd(dT1, dT2) {
  if (Math.abs(dT1-dT2) < 0.001) return dT1;
  if (dT1 <= 0 || dT2 <= 0) return NaN;
  return (dT1-dT2) / Math.log(dT1/dT2);
}

function htFcorrShell(R, P, nShellPasses) {
  if (P < 1e-10) return 1;
  if (Math.abs(R-1) < 1e-6) {
    const s = P*Math.SQRT2;
    const den = (1-P)*Math.log((2-P*(2-Math.SQRT2))/(2-P*(2+Math.SQRT2)));
    return Math.abs(den) < 1e-10 ? 1 : s/den;
  }
  const S = Math.sqrt(R*R+1);
  const num = S*Math.log((1-P)/(1-R*P));
  const a = 2/P-1-R+S, b = 2/P-1-R-S;
  const den = (R-1)*Math.log(a/b);
  if (Math.abs(den) < 1e-10 || a/b <= 0) return NaN;
  return Math.min(num/den, 1);
}

function htEpsFromNTU(NTU, Cr, config) {
  if (Cr < 1e-10) return 1-Math.exp(-NTU);
  switch (config) {
    case 'counter':
      if (Math.abs(Cr-1)<1e-6) return NTU/(1+NTU);
      return (1-Math.exp(-NTU*(1-Cr)))/(1-Cr*Math.exp(-NTU*(1-Cr)));
    case 'parallel': return (1-Math.exp(-NTU*(1+Cr)))/(1+Cr);
    case 'cross-UU': { const n=Math.pow(NTU,0.22); return 1-Math.exp((n/Cr)*(Math.exp(-Cr*Math.pow(NTU,0.78))-1)); }
    case 'cross-MU': return (1/Cr)*(1-Math.exp(-Cr*(1-Math.exp(-NTU))));
    case 'cross-UM': return 1-Math.exp(-(1/Cr)*(1-Math.exp(-Cr*NTU)));
    case 'shell-1-2': case 'shell-1-4': {
      const E=Math.sqrt(1+Cr*Cr), expE=Math.exp(-NTU*E);
      return 2/(1+Cr+E*(1+expE)/(1-expE));
    }
    default: return NaN;
  }
}

function htNTUfromEps(eps, Cr, config) {
  if (eps <= 0) return 0;
  if (Cr < 1e-10) return -Math.log(1-eps);
  switch (config) {
    case 'counter':
      if (Math.abs(Cr-1)<1e-6) return eps/(1-eps);
      return (1/(Cr-1))*Math.log((eps-1)/(eps*Cr-1));
    case 'parallel': return -Math.log(1-eps*(1+Cr))/(1+Cr);
    default: {
      let lo=0, hi=50, mid;
      for (let i=0; i<60; i++) { mid=(lo+hi)/2; if (htEpsFromNTU(mid,Cr,config)<eps) lo=mid; else hi=mid; }
      return mid;
    }
  }
}

function htCalcHX() {
  const mode = document.getElementById('hx-mode').value;
  const config = document.getElementById('hx-config').value;
  const Thi = parseFloat(document.getElementById('hx-Thi').value);
  const Tci = parseFloat(document.getElementById('hx-Tci').value);
  const Ch = parseFloat(document.getElementById('hx-Ch').value);
  const Cc = parseFloat(document.getElementById('hx-Cc').value);
  const U_clean = parseFloat(document.getElementById('hx-U').value);
  const Rf = parseFloat(document.getElementById('hx-Rf').value) || 0;
  const U = (Rf > 0) ? 1/(1/U_clean + Rf) : U_clean;
  const Cmin = Math.min(Ch,Cc), Cmax = Math.max(Ch,Cc), Cr = Cmin/Cmax, Qmax = Cmin*(Thi-Tci);

  let Q, eps, NTU, A, Tho, Tco, LMTD_val, F, items = [];

  if (mode === 'design') {
    Tho = parseFloat(document.getElementById('hx-Tho').value);
    Tco = parseFloat(document.getElementById('hx-Tco').value);
    const Qh = Ch*(Thi-Tho), Qc = Cc*(Tco-Tci);
    Q = (Qh+Qc)/2;
    if (Math.abs(Qh-Qc)/Math.max(Qh,Qc) > 0.05) items.push({label:'Energy balance warning', value:'Q<sub>h</sub>='+htFmt(Qh,0)+'W, Q<sub>c</sub>='+htFmt(Qc,0)+'W', full:true});
    eps = Q/Qmax;
    const dT1_cf = Thi-Tco, dT2_cf = Tho-Tci, LMTD_cf = htLmtd(dT1_cf, dT2_cf);
    NTU = htNTUfromEps(eps, Cr, config);
    A = NTU*Cmin/U;
    LMTD_val = LMTD_cf;
    F = (isFinite(LMTD_cf)&&LMTD_cf>0) ? Q/(U*A*LMTD_cf) : NaN;
    if (config === 'counter') { F = 1.0; A = Q/(U*LMTD_cf); }
    else if (config === 'parallel') { const dT1_p=Thi-Tci, dT2_p=Tho-Tco; LMTD_val=htLmtd(dT1_p,dT2_p); F=1.0; A=Q/(U*LMTD_val); }
    else if (config.startsWith('shell')) {
      const R = (Math.abs(Tco-Tci)>0.01)?(Thi-Tho)/(Tco-Tci):1e10;
      const P = (Math.abs(Thi-Tci)>0.01)?(Tco-Tci)/(Thi-Tci):0;
      F = htFcorrShell(R, P, config==='shell-1-4'?2:1);
      if (isFinite(F)&&F>0) A = Q/(U*F*LMTD_cf);
    } else { F = (isFinite(LMTD_cf)&&LMTD_cf>0&&A>0) ? Q/(U*A*LMTD_cf) : NaN; }
    items = items.concat([
      {label:'Heat duty Q&#x0307;', value:htFmt(Q,0), unit:'W', highlight:true},
      {label:'Required area A', value:htFmt(A,2), unit:'m&sup2;', highlight:true},
      {label:'Effectiveness &epsilon;', value:htFmt(eps,4)},
      {label:'NTU', value:htFmt(NTU,3)},
      {label:'LMTD (counterflow ref.)', value:htFmt(LMTD_cf,2), unit:'K'},
      {label:'F-correction factor', value:isFinite(F)?htFmt(F,4):'N/A'},
      {label:'Effective &Delta;T<sub>m</sub>', value:isFinite(F)?htFmt(F*LMTD_cf,2):htFmt(Q/(U*A),2), unit:'K'},
      {label:'C<sub>r</sub> = C<sub>min</sub>/C<sub>max</sub>', value:htFmt(Cr,4)},
      {label:'C<sub>min</sub>', value:htFmt(Cmin,0), unit:'W/K'},
      {label:'Q<sub>max</sub>', value:htFmt(Qmax,0), unit:'W'}
    ]);
  } else if (mode === 'rating') {
    A = parseFloat(document.getElementById('hx-A').value);
    NTU = U*A/Cmin;
    eps = htEpsFromNTU(NTU, Cr, config);
    Q = eps*Qmax;
    Tho = Thi - Q/Ch; Tco = Tci + Q/Cc;
    const dT1_cf=Thi-Tco, dT2_cf=Tho-Tci, LMTD_cf=htLmtd(dT1_cf,dT2_cf);
    F = (LMTD_cf>0)?Q/(U*A*LMTD_cf):NaN;
    items = [
      {label:'Heat duty Q&#x0307;', value:htFmt(Q,0), unit:'W', highlight:true},
      {label:'T<sub>h,out</sub>', value:htFmt(Tho,1), unit:'&deg;C', highlight:true},
      {label:'T<sub>c,out</sub>', value:htFmt(Tco,1), unit:'&deg;C', highlight:true},
      {label:'Effectiveness &epsilon;', value:htFmt(eps,4)},
      {label:'NTU', value:htFmt(NTU,3)},
      {label:'LMTD (counterflow ref.)', value:htFmt(LMTD_cf,2), unit:'K'},
      {label:'F-correction factor', value:isFinite(F)?htFmt(F,4):'N/A'},
      {label:'C<sub>r</sub>', value:htFmt(Cr,4)},
      {label:'C<sub>min</sub>', value:htFmt(Cmin,0), unit:'W/K'},
      {label:'Q<sub>max</sub>', value:htFmt(Qmax,0), unit:'W'}
    ];
  } else {
    Tho = parseFloat(document.getElementById('hx-Tho').value);
    Tco = parseFloat(document.getElementById('hx-Tco').value);
    A = parseFloat(document.getElementById('hx-A').value);
    const Qh=Ch*(Thi-Tho), Qc=Cc*(Tco-Tci);
    Q = (Qh+Qc)/2; eps = Q/Qmax; NTU = U*A/Cmin;
    const eps_calc = htEpsFromNTU(NTU, Cr, config);
    const dT1_cf=Thi-Tco, dT2_cf=Tho-Tci, LMTD_cf=htLmtd(dT1_cf,dT2_cf);
    F = (LMTD_cf>0&&A>0)?Q/(U*A*LMTD_cf):NaN;
    const U_eff = (A>0&&LMTD_cf>0&&isFinite(F)&&F>0)?Q/(A*F*LMTD_cf):Q/(A*LMTD_cf);
    items = [
      {label:'Q&#x0307; (from temps)', value:htFmt(Q,0), unit:'W', highlight:true},
      {label:'&epsilon; (actual)', value:htFmt(eps,4), highlight:true},
      {label:'&epsilon; (from NTU)', value:htFmt(eps_calc,4)},
      {label:'Q<sub>h</sub> = C<sub>h</sub>&middot;&Delta;T<sub>h</sub>', value:htFmt(Qh,0), unit:'W'},
      {label:'Q<sub>c</sub> = C<sub>c</sub>&middot;&Delta;T<sub>c</sub>', value:htFmt(Qc,0), unit:'W'},
      {label:'Energy balance error', value:htFmt(Math.abs(Qh-Qc)/Math.max(Math.abs(Qh),Math.abs(Qc))*100,1), unit:'%'},
      {label:'NTU', value:htFmt(NTU,3)},
      {label:'LMTD (counterflow)', value:htFmt(LMTD_cf,2), unit:'K'},
      {label:'F-factor', value:isFinite(F)?htFmt(F,4):'N/A'},
      {label:'C<sub>r</sub>', value:htFmt(Cr,4)},
      {label:'U<sub>eff</sub> (back-calc)', value:htFmt(U_eff,1), unit:'W/(m&sup2;&middot;K)'},
      {label:'Q<sub>max</sub>', value:htFmt(Qmax,0), unit:'W'}
    ];
  }
  if (Rf > 0) {
    items.push({label:'U<sub>clean</sub>', value:htFmt(U_clean,1), unit:'W/(m&sup2;&middot;K)'});
    items.push({label:'U<sub>fouled</sub>', value:htFmt(U,1), unit:'W/(m&sup2;&middot;K)'});
    items.push({label:'R<sub>fouling</sub>', value:htFmtSci(Rf,2), unit:'m&sup2;&middot;K/W'});
  }
  document.getElementById('hx-results-grid').innerHTML = htResultHTML(items);
  const configNames = {'counter':'Counterflow','parallel':'Parallel flow','cross-UU':'Crossflow (both unmixed)',
    'cross-MU':'Crossflow (C<sub>max</sub> mixed)','cross-UM':'Crossflow (C<sub>min</sub> mixed)',
    'shell-1-2':'Shell & tube 1-2 (TEMA E)','shell-1-4':'Shell & tube 1-4'};
  const modeNames = {'design':'Design (sizing)','rating':'Rating (performance)','check':'Performance check'};
  let note = '<strong>'+modeNames[mode]+'</strong> &mdash; '+configNames[config];
  note += '<br>Method: &epsilon;-NTU (VDI C3) with LMTD cross-check.';
  if (isFinite(F)&&F<0.75) note += '<br><strong>Warning:</strong> F = '+htFmt(F,3)+' &lt; 0.75. Consider more shell passes or different arrangement.';
  if (eps>0.95) note += '<br><strong>Note:</strong> &epsilon; &gt; 0.95 &mdash; approaching thermodynamic limit.';
  if (config==='parallel'&&eps>1/(1+Cr)) note += '<br><strong>Warning:</strong> Requested &epsilon; exceeds parallel-flow limit of '+htFmt(1/(1+Cr),3)+'.';
  document.getElementById('hx-results-note').innerHTML = note;
  document.getElementById('hx-results').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROUP BY CATEGORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const categories = [];
const catMap = {};
CALCS.forEach(c => {
  if (!catMap[c.cat]) { catMap[c.cat] = { name:c.cat, color:c.color, icon:c.icon, items:[] }; categories.push(catMap[c.cat]); }
  catMap[c.cat].items.push(c);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeCalc = null;
let sidebarOpen = window.innerWidth > 768;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD SIDEBAR NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildNav(filter='') {
  const nav = document.getElementById('navList');
  nav.innerHTML = '';
  const lf = filter.toLowerCase();
  categories.forEach(cat => {
    const items = cat.items.filter(c => !lf || c.name.toLowerCase().includes(lf) || c.id.toLowerCase().includes(lf) || c.desc.toLowerCase().includes(lf));
    if (!items.length) return;
    const group = document.createElement('div');
    group.className = 'cat-group';
    const header = document.createElement('div');
    header.className = 'cat-header';
    header.innerHTML = `<span class="cat-dot" style="background:${cat.color}"></span><span class="cat-label">${cat.name}</span><svg class="cat-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>`;
    header.addEventListener('click', () => header.classList.toggle('collapsed'));
    group.appendChild(header);
    const list = document.createElement('div');
    list.className = 'cat-items';
    items.forEach(c => {
      const item = document.createElement('div');
      item.className = 'nav-item' + (activeCalc === c.id ? ' active' : '');
      item.dataset.id = c.id;
      item.innerHTML = `<span class="nav-code">${c.id}</span><span class="nav-label">${c.name}</span>`;
      item.addEventListener('click', () => showCalc(c.id));
      list.appendChild(item);
    });
    group.appendChild(list);
    nav.appendChild(group);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD CALCULATOR PANEL HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCalcPanel(c) {
  const panel = document.createElement('div');
  panel.className = 'calc-panel';
  panel.id = 'panel-' + c.id;
  let html = `<div class="calc-title">${c.name}</div><div class="calc-desc">${c.desc}</div>`;

  // Full custom render (heat transfer calculators)
  if (c.fullCustomRender) {
    html += c.fullCustomRender();
    if (c.formula) {
      html += `<div class="calc-section"><h3><span class="dot formula-dot"></span>Formulas</h3><div class="formula-box">${c.formula}</div></div>`;
    }
    panel.innerHTML = html;
    return panel;
  }

  // Custom render (reference tables)
  if (c.customRender) {
    html += `<div class="calc-section">${c.customRender()}</div>`;
  }

  // Inputs
  if (c.inputs && c.inputs.length) {
    html += `<div class="calc-section"><h3><span class="dot input-dot"></span>Inputs</h3><div class="field-grid">`;
    c.inputs.forEach(inp => {
      if (inp.type === 'select') {
        html += `<div class="field"><label>${inp.label} <span class="unit">${inp.unit}</span></label><select id="${c.id}_${inp.id}" data-calc="${c.id}">`;
        inp.options.forEach(o => { html += `<option value="${o}" ${o==inp.val?'selected':''}>${o}</option>`; });
        html += `</select></div>`;
      } else {
        html += `<div class="field"><label>${inp.label} <span class="unit">${inp.unit}</span></label><input type="number" id="${c.id}_${inp.id}" value="${inp.val}" step="any" data-calc="${c.id}"></div>`;
      }
    });
    html += `</div><button class="calc-btn" data-calc="${c.id}">Calculate</button></div>`;
  }

  // Outputs
  if (c.outputs && c.outputs.length) {
    html += `<div class="calc-section"><h3><span class="dot output-dot"></span>Results</h3><div class="field-grid">`;
    c.outputs.forEach(o => {
      const [id,label,unit] = o.split('|');
      html += `<div class="field"><label>${label} <span class="unit">${unit}</span></label><input type="text" id="${c.id}_out_${id}" readonly value="â€”"></div>`;
    });
    html += `</div></div>`;
  }

  // Formula
  if (c.formula) {
    html += `<div class="calc-section"><h3><span class="dot formula-dot"></span>Formulas</h3><div class="formula-box">${c.formula}</div></div>`;
  }

  panel.innerHTML = html;
  return panel;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runCalc(id) {
  const c = CALCS.find(x => x.id === id);
  if (!c || !c.inputs || !c.inputs.length) return;
  const vals = {};
  c.inputs.forEach(inp => {
    const el = document.getElementById(c.id + '_' + inp.id);
    vals[inp.id] = inp.type === 'select' ? el.value : parseFloat(el.value);
  });
  try {
    const results = c.calc(vals);
    c.outputs.forEach(o => {
      const outId = o.split('|')[0];
      const el = document.getElementById(c.id + '_out_' + outId);
      if (el) { el.value = results[outId] ?? 'â€”'; el.classList.remove('warn'); }
    });
  } catch(e) {
    console.error('Calc error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOW CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCalc(id) {
  const c = CALCS.find(x => x.id === id);
  if (!c) return;
  activeCalc = id;
  history.replaceState(null, '', '#' + id);
  document.getElementById('headerTitle').textContent = c.name;
  document.getElementById('headerSub').textContent = c.cat + ' Â· ' + c.id;
  document.getElementById('welcome').classList.add('hidden');

  // Hide all panels
  document.querySelectorAll('.calc-panel').forEach(p => p.classList.remove('active'));

  // Show or create panel
  let panel = document.getElementById('panel-' + id);
  if (!panel) {
    panel = buildCalcPanel(c);
    document.getElementById('calcContainer').appendChild(panel);

    // Wire up events
    if (c.customInit) {
      // Heat transfer calculators: custom initialization
      c.customInit(panel);
    } else {
      panel.querySelectorAll('input[data-calc], select[data-calc]').forEach(el => {
        el.addEventListener('input', () => runCalc(id));
        el.addEventListener('change', () => runCalc(id));
      });
      panel.querySelectorAll('button[data-calc]').forEach(btn => {
        btn.addEventListener('click', () => runCalc(id));
      });

      // Auto-calculate on open
      setTimeout(() => runCalc(id), 50);
    }
  }
  panel.classList.add('active');

  // Update nav highlight
  document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.id === id));

  // Scroll main to top
  document.getElementById('main').scrollTop = 0;

  // Close sidebar on mobile
  if (window.innerWidth <= 768) closeSidebar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSidebar() {
  sidebarOpen = true;
  document.getElementById('sidebar').classList.remove('collapsed');
  if (window.innerWidth <= 768) { document.getElementById('sidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('show'); }
  document.getElementById('main').classList.remove('expanded');
}
function closeSidebar() {
  sidebarOpen = false;
  if (window.innerWidth <= 768) { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); }
  else { document.getElementById('sidebar').classList.add('collapsed'); document.getElementById('main').classList.add('expanded'); }
}
function toggleSidebar() { sidebarOpen ? closeSidebar() : openSidebar(); }
document.getElementById('menuBtn').addEventListener('click', toggleSidebar);
document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('searchInput').addEventListener('input', e => buildNav(e.target.value));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const quickPicks = ['e2_1','L10','e3_6a','e3_8','f_2','pipeflow','key','uts'];
const grid = document.getElementById('quickGrid');
quickPicks.forEach(id => {
  const c = CALCS.find(x => x.id === id);
  if (!c) return;
  const card = document.createElement('div');
  card.className = 'quick-card';
  card.innerHTML = `<div class="qc-icon">${c.icon}</div><div class="qc-label">${c.name}</div>`;
  card.addEventListener('click', () => showCalc(id));
  grid.appendChild(card);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); document.getElementById('searchInput').focus(); openSidebar(); }
  if (e.key === 'Escape') { document.getElementById('searchInput').blur(); if (window.innerWidth <= 768) closeSidebar(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA INSTALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt=e; document.getElementById('installBanner').classList.add('show'); });
document.getElementById('installBtn').addEventListener('click', async()=>{ if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;document.getElementById('installBanner').classList.remove('show');} });
document.getElementById('installDismiss').addEventListener('click', ()=>document.getElementById('installBanner').classList.remove('show'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildNav();

function handleHash() {
  const hash = location.hash.replace('#','');
  if (hash && CALCS.find(c => c.id === hash)) showCalc(hash);
}
window.addEventListener('hashchange', handleHash);
handleHash();

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});

window.addEventListener('resize', () => {
  if (window.innerWidth > 768) {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    if (sidebarOpen) { document.getElementById('sidebar').classList.remove('collapsed'); document.getElementById('main').classList.remove('expanded'); }
  }
});
</script>
</body>
</html>